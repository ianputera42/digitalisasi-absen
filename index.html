<!DOCTYPE html>
<html lang="id" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Absensi Siswa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            box-sizing: border-box;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .card-hover {
            transition: all 0.3s ease;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="h-full bg-gray-50">
    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-full flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
        <div class="max-w-md w-full space-y-8">
            <div class="text-center">
                <i class="fas fa-graduation-cap text-6xl text-blue-600 mb-4"></i>
                <h2 class="text-3xl font-bold text-gray-900">Dashboard Absensi Siswa</h2>
                <p class="mt-2 text-gray-600">Masukkan kode akses untuk login</p>
            </div>
            <form class="mt-8 space-y-6" onsubmit="handleLogin(event)">
                <div>
                    <label for="accessCode" class="block text-sm font-medium text-gray-700 mb-2">Kode Akses</label>
                    <input id="accessCode" type="text" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="Masukkan kode akses">
                </div>
                <button type="submit" 
                        class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-sign-in-alt mr-2"></i>
                    Masuk
                </button>
            </form>
            <div class="mt-6 text-xs text-gray-500 text-center">
                <p><strong>Demo Kode Akses:</strong></p>
                <p>ADMIN001 (Admin) | GURU001 (Guru) | WALI001 (Wali Kelas) | KEPSEK001 (Kepala Sekolah)</p>
            </div>

            <!-- Pencarian Data Absensi untuk Orang Tua -->
            <div class="mt-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                <h3 class="text-lg font-semibold text-blue-900 mb-4 text-center">
                    <i class="fas fa-search mr-2"></i>Cek Kehadiran Siswa
                </h3>
                <p class="text-sm text-blue-700 text-center mb-4">Khusus untuk Orang Tua/Wali Siswa - Masukkan NISN untuk melihat data kehadiran</p>
                
                <form onsubmit="searchStudentAttendance(event)" class="space-y-4">
                    <div>
                        <label for="searchNisn" class="block text-sm font-medium text-blue-800 mb-2">NISN Siswa</label>
                        <input id="searchNisn" type="text" required 
                               class="w-full px-3 py-2 border border-blue-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                               placeholder="Masukkan NISN siswa (contoh: 1234567890)">
                    </div>
                    <button type="submit" 
                            class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                        <i class="fas fa-search mr-2"></i>
                        Cari Data Kehadiran
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden min-h-full">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center">
                        <i class="fas fa-graduation-cap text-2xl text-blue-600 mr-3"></i>
                        <h1 class="text-xl font-semibold text-gray-900">Dashboard Absensi</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="userRole" class="text-sm text-gray-600"></span>
                        <button onclick="logout()" class="text-red-600 hover:text-red-800">
                            <i class="fas fa-sign-out-alt"></i> Keluar
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="flex h-full">
            <!-- Sidebar -->
            <nav class="w-64 bg-white shadow-sm border-r min-h-screen">
                <div class="p-4">
                    <ul id="menuList" class="space-y-2">
                        <!-- Menu items will be populated by JavaScript -->
                    </ul>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="flex-1 p-6">
                <div id="content" class="fade-in">
                    <!-- Content will be populated by JavaScript -->
                </div>
            </main>
        </div>

        <!-- Footer -->
        <footer class="bg-gray-800 text-white py-6 mt-8">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="text-center space-y-3">
                    <div class="text-lg font-semibold text-blue-300">
                        Sistem ini dirancang dari AI oleh Ian Dwi Putera, S.Pd
                    </div>
                    <div class="text-sm text-gray-300">
                        ¬© 2025 - Platform Absensi Interaktif - Ian dwi putera (wa +. ) ê¶Çñ®ÜêÄ™ñ†ãêÄ™êÄ™
                    </div>
                    <div class="text-xs text-gray-400 max-w-2xl mx-auto leading-relaxed">
                        Hak Cipta Dilindungi | Semua fitur dirancang untuk membantu guru Indonesia menciptakan pembelajaran dan manajemen yang berkualitas
                    </div>
                    <div class="flex justify-center items-center space-x-4 pt-2">
                        <div class="flex items-center text-xs text-gray-400">
                            <i class="fas fa-heart text-red-400 mr-1"></i>
                            Dibuat dengan dedikasi untuk pendidikan Indonesia
                        </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

    <!-- Student Attendance Search Result Modal -->
    <div id="attendanceSearchModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Data Kehadiran Siswa</h3>
                <button onclick="closeAttendanceSearchModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="attendanceSearchResult">
                <!-- Search result will be populated here -->
            </div>
        </div>
    </div>

    <!-- WhatsApp Modal -->
    <div id="whatsappModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold">Kirim Pesan WhatsApp</h3>
                <button onclick="closeWhatsAppModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <form onsubmit="sendWhatsApp(event)">
                <div class="mb-4">
                    <label for="phoneNumber" class="block text-sm font-medium text-gray-700 mb-2">Nomor WhatsApp</label>
                    <input id="phoneNumber" type="text" required 
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                           placeholder="08xxxxxxxxxx">
                </div>
                <div class="mb-4">
                    <label for="messageTemplate" class="block text-sm font-medium text-gray-700 mb-2">Template Pesan</label>
                    <select id="messageTemplate" onchange="updateMessage()" 
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        <option value="sangat_bermasalah">Sangat Bermasalah (‚â•7 Alpha)</option>
                        <option value="perlu_perhatian">Perlu Perhatian Khusus (4-7 Alpha)</option>
                        <option value="perlu_pengawasan">Perlu Pengawasan (2-3 Alpha)</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                <div class="mb-4">
                    <label for="messageContent" class="block text-sm font-medium text-gray-700 mb-2">Isi Pesan</label>
                    <textarea id="messageContent" rows="4" required
                              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeWhatsAppModal()" 
                            class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                        Batal
                    </button>
                    <button type="submit" 
                            class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                        <i class="fab fa-whatsapp mr-2"></i>Kirim
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let currentMenu = 'beranda';
        let nextStudentId = 6;
        let nextAttendanceId = 4;
        let nextTeacherId = 6;
        let nextUserId = 5;
        
        // Integrated data management
        const users = {
            'ADMIN001': { role: 'admin', name: 'Admin Sistem' },
            'GURU001': { role: 'guru', name: 'Budi Santoso', mapel: 'Matematika' },
            'WALI001': { role: 'wali', name: 'Siti Nurhaliza', kelas: 'X-A' },
            'KEPSEK001': { role: 'kepsek', name: 'Dr. Ahmad Wijaya' }
        };

        const students = [
            { id: 1, nama: 'Ahmad Rizki', nisn: '1234567890', kelas: 'X-A', noOrtu: '081234567890', alpha: 0, sakit: 0, izin: 0 },
            { id: 2, nama: 'Siti Aminah', nisn: '1234567891', kelas: 'X-A', noOrtu: '081234567891', alpha: 0, sakit: 0, izin: 0 },
            { id: 3, nama: 'Budi Hartono', nisn: '1234567892', kelas: 'X-B', noOrtu: '081234567892', alpha: 0, sakit: 0, izin: 0 },
            { id: 4, nama: 'Dewi Sartika', nisn: '1234567893', kelas: 'XI-A', noOrtu: '081234567893', alpha: 0, sakit: 0, izin: 0 },
            { id: 5, nama: 'Eko Prasetyo', nisn: '1234567894', kelas: 'XI-B', noOrtu: '081234567894', alpha: 0, sakit: 0, izin: 0 }
        ];

        const attendanceData = [
            // Sample data untuk testing - akan diupdate otomatis saat guru input absensi
            { id: 1, siswaId: 1, tanggal: '2024-01-15', status: 'alpha', mapel: 'Matematika', guru: 'Budi Santoso', keterangan: 'Fungsi Linear', timestamp: new Date().toISOString() },
            { id: 2, siswaId: 2, tanggal: '2024-01-15', status: 'sakit', mapel: 'Bahasa Indonesia', guru: 'Siti Nurhaliza', keterangan: 'Teks Eksposisi', timestamp: new Date().toISOString() },
            { id: 3, siswaId: 3, tanggal: '2024-01-14', status: 'izin', mapel: 'Fisika', guru: 'Ahmad Wijaya', keterangan: 'Gerak Lurus', timestamp: new Date().toISOString() }
        ];

        const teacherAttendanceData = [
            // Sample data kehadiran guru
            { id: 1, nama: 'Budi Santoso', kelas: 'X-A', mapel: 'Matematika', materi: 'Fungsi Linear', waktu: '07:30', lokasi: 'Sekolah', tanggal: '15 Jan 2024', timestamp: new Date().toISOString() },
            { id: 2, nama: 'Siti Nurhaliza', kelas: 'X-A', mapel: 'Bahasa Indonesia', materi: 'Teks Eksposisi', waktu: '08:30', lokasi: 'Sekolah', tanggal: '15 Jan 2024', timestamp: new Date().toISOString() }
        ];

        const whatsappHistory = [];

        const messageTemplates = {
            sangat_bermasalah: 'Yth. Orang Tua/Wali Murid,\n\nKami informasikan bahwa putra/putri Anda telah tidak hadir (alpha) sebanyak 7 kali atau lebih dalam 30 hari terakhir. Mohon segera menghubungi wali kelas untuk koordinasi lebih lanjut.\n\nTerima kasih.',
            perlu_perhatian: 'Yth. Orang Tua/Wali Murid,\n\nKami informasikan bahwa putra/putri Anda telah tidak hadir (alpha) sebanyak 4-7 kali dalam 30 hari terakhir. Mohon perhatian khusus terhadap kehadiran putra/putri Anda.\n\nTerima kasih.',
            perlu_pengawasan: 'Yth. Orang Tua/Wali Murid,\n\nKami informasikan bahwa putra/putri Anda telah tidak hadir (alpha) sebanyak 2-3 kali dalam 30 hari terakhir. Mohon pengawasan lebih terhadap kehadiran putra/putri Anda.\n\nTerima kasih.'
        };

        // Data integration functions
        function updateStudentStats() {
            students.forEach(student => {
                const studentAttendance = attendanceData.filter(a => a.siswaId === student.id);
                student.alpha = studentAttendance.filter(a => a.status === 'alpha').length;
                student.sakit = studentAttendance.filter(a => a.status === 'sakit').length;
                student.izin = studentAttendance.filter(a => a.status === 'izin').length;
            });
        }

        function getStudentById(id) {
            return students.find(s => s.id === id);
        }

        function getStudentsByClass(kelas) {
            return students.filter(s => s.kelas === kelas);
        }

        function getAttendanceByStudent(siswaId) {
            return attendanceData.filter(a => a.siswaId === siswaId);
        }

        function getAttendanceByDateRange(startDate, endDate) {
            return attendanceData.filter(a => {
                const attendanceDate = new Date(a.tanggal);
                return attendanceDate >= new Date(startDate) && attendanceDate <= new Date(endDate);
            });
        }

        function addAttendanceRecord(siswaId, tanggal, status, mapel, guru, keterangan = '') {
            const newRecord = {
                id: nextAttendanceId++,
                siswaId: parseInt(siswaId),
                tanggal,
                status,
                mapel,
                guru,
                keterangan,
                timestamp: new Date().toISOString()
            };
            attendanceData.push(newRecord);
            updateStudentStats();
            return newRecord;
        }

        function addTeacherAttendanceRecord(nama, kelas, mapel, materi, waktu, lokasi) {
            const newRecord = {
                id: nextTeacherId++,
                nama,
                kelas,
                mapel,
                materi,
                waktu,
                lokasi,
                tanggal: new Date().toLocaleDateString('id-ID'),
                timestamp: new Date().toISOString()
            };
            teacherAttendanceData.push(newRecord);
            return newRecord;
        }

        function addWhatsAppHistory(phone, studentName, message, category) {
            const newHistory = {
                id: Date.now(),
                phone,
                studentName,
                message,
                category,
                timestamp: new Date().toISOString(),
                tanggal: new Date().toLocaleDateString('id-ID'),
                waktu: new Date().toLocaleTimeString('id-ID')
            };
            whatsappHistory.push(newHistory);
            return newHistory;
        }

        function getCategoryText(category) {
            const categoryTexts = {
                'sangat_bermasalah': 'Sangat Bermasalah',
                'perlu_perhatian': 'Perlu Perhatian',
                'perlu_pengawasan': 'Perlu Pengawasan',
                'custom': 'Custom'
            };
            return categoryTexts[category] || 'Notifikasi';
        }

        // Menu configurations for each role
        const menuConfig = {
            admin: [
                { id: 'beranda', icon: 'fas fa-home', text: 'Beranda' },
                { id: 'tambah-user', icon: 'fas fa-user-plus', text: 'Tambah Data Pengguna Sistem' },
                { id: 'kelola-user', icon: 'fas fa-users', text: 'Kelola User' },
                { id: 'kelola-siswa', icon: 'fas fa-user-graduate', text: 'Kelola Siswa' },
                { id: 'laporan-absensi', icon: 'fas fa-chart-bar', text: 'Laporan Absensi' },
                { id: 'absensi-siswa', icon: 'fas fa-clipboard-list', text: 'Absensi Siswa' },
                { id: 'ringkasan-guru', icon: 'fas fa-chalkboard-teacher', text: 'Ringkasan Guru' },
                { id: 'kehadiran-guru-admin', icon: 'fas fa-user-check', text: 'Kehadiran Guru' },
                { id: 'template-wa', icon: 'fab fa-whatsapp', text: 'Template WhatsApp' }
            ],
            guru: [
                { id: 'beranda', icon: 'fas fa-home', text: 'Beranda' },
                { id: 'absensi-guru', icon: 'fas fa-map-marker-alt', text: 'Kehadiran Guru' },
                { id: 'input-absensi', icon: 'fas fa-edit', text: 'Input Absensi Siswa' },
                { id: 'rekap-absensi', icon: 'fas fa-history', text: 'Rekapan Absensi Saya' },
                { id: 'riwayat-kehadiran', icon: 'fas fa-clock', text: 'Riwayat Kehadiran Saya' }
            ],
            wali: [
                { id: 'beranda', icon: 'fas fa-home', text: 'Beranda' },
                { id: 'absensi-kelas', icon: 'fas fa-chalkboard-teacher', text: 'Absensi Kelas' },
                { id: 'kategori-siswa', icon: 'fas fa-exclamation-triangle', text: 'Kategori Siswa' },
                { id: 'kirim-wa', icon: 'fab fa-whatsapp', text: 'Kirim WhatsApp' }
            ],
            kepsek: [
                { id: 'beranda', icon: 'fas fa-home', text: 'Beranda' },
                { id: 'ringkasan-siswa', icon: 'fas fa-users', text: 'Ringkasan Siswa' },
                { id: 'ringkasan-guru', icon: 'fas fa-chalkboard-teacher', text: 'Ringkasan Guru' },
                { id: 'riwayat-guru-kepsek', icon: 'fas fa-user-clock', text: 'Riwayat Kehadiran Guru' },
                { id: 'kategori-siswa', icon: 'fas fa-exclamation-triangle', text: 'Kategori Siswa' },
                { id: 'kirim-wa', icon: 'fab fa-whatsapp', text: 'Kirim WhatsApp' }
            ]
        };

        // Login function
        function handleLogin(event) {
            event.preventDefault();
            const accessCode = document.getElementById('accessCode').value;
            
            if (users[accessCode]) {
                currentUser = users[accessCode];
                document.getElementById('loginScreen').classList.add('hidden');
                document.getElementById('dashboard').classList.remove('hidden');
                document.getElementById('userRole').textContent = `${currentUser.name} (${getRoleText(currentUser.role)})`;
                
                initializeDashboard();
            } else {
                alert('Kode akses tidak valid!');
            }
        }

        function getRoleText(role) {
            const roleTexts = {
                admin: 'Administrator',
                guru: 'Guru',
                wali: 'Wali Kelas',
                kepsek: 'Kepala Sekolah'
            };
            return roleTexts[role] || role;
        }

        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').classList.remove('hidden');
            document.getElementById('dashboard').classList.add('hidden');
            document.getElementById('accessCode').value = '';
        }

        function initializeDashboard() {
            renderMenu();
            showContent('beranda');
        }

        function renderMenu() {
            const menuList = document.getElementById('menuList');
            const menus = menuConfig[currentUser.role] || [];
            
            menuList.innerHTML = menus.map(menu => `
                <li>
                    <button onclick="showContent('${menu.id}')" 
                            class="w-full text-left px-3 py-2 rounded-md text-gray-700 hover:bg-blue-50 hover:text-blue-600 flex items-center ${currentMenu === menu.id ? 'bg-blue-100 text-blue-600' : ''}">
                        <i class="${menu.icon} mr-3"></i>
                        ${menu.text}
                    </button>
                </li>
            `).join('');
        }

        function showContent(menuId) {
            currentMenu = menuId;
            renderMenu();
            
            const content = document.getElementById('content');
            content.innerHTML = getContentForMenu(menuId);
            content.className = 'fade-in';
        }

        function getContentForMenu(menuId) {
            switch(menuId) {
                case 'beranda':
                    return renderBeranda();
                case 'tambah-user':
                    return renderTambahUser();
                case 'kelola-user':
                    return renderKelolaUser();
                case 'kelola-siswa':
                    return renderKelolaSiswa();
                case 'laporan-absensi':
                    return renderLaporanAbsensi();
                case 'absensi-siswa':
                    return renderAbsensiSiswa();
                case 'template-wa':
                    return renderTemplateWA();
                case 'absensi-guru':
                    return renderAbsensiGuru();
                case 'input-absensi':
                    return renderInputAbsensi();
                case 'rekap-absensi':
                    return renderRekapAbsensi();
                case 'riwayat-kehadiran':
                    return renderRiwayatKehadiranGuru();
                case 'kehadiran-guru-admin':
                    return renderKehadiranGuruAdmin();
                case 'absensi-kelas':
                    return renderAbsensiKelas();
                case 'kategori-siswa':
                    return renderKategoriSiswa();
                case 'kirim-wa':
                    return renderKirimWA();
                case 'ringkasan-siswa':
                    return renderRingkasanSiswa();
                case 'ringkasan-guru':
                    return currentUser.role === 'admin' ? renderAdminRingkasanGuru() : renderRingkasanGuru();
                case 'riwayat-guru-kepsek':
                    return renderRiwayatGuruKepsek();
                default:
                    return '<div class="text-center text-gray-500">Menu tidak ditemukan</div>';
            }
        }

        function renderBeranda() {
            updateStudentStats();
            const totalSiswa = students.length;
            const totalAlpha = students.reduce((sum, s) => sum + s.alpha, 0);
            const totalSakit = students.reduce((sum, s) => sum + s.sakit, 0);
            const totalIzin = students.reduce((sum, s) => sum + s.izin, 0);
            const totalKehadiran = attendanceData.filter(a => a.status === 'hadir').length;

            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Selamat Datang, ${currentUser.name}</h2>
                    <p class="text-gray-600">Dashboard Absensi Siswa - Data 30 Hari Terakhir</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-lg shadow-sm border card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Hadir</p>
                                <p class="text-2xl font-bold text-gray-900">${totalKehadiran}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-red-600">
                                <i class="fas fa-times text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Alpha</p>
                                <p class="text-2xl font-bold text-gray-900">${totalAlpha}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-bed text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Sakit</p>
                                <p class="text-2xl font-bold text-gray-900">${totalSakit}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white p-6 rounded-lg shadow-sm border card-hover">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-info text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Izin</p>
                                <p class="text-2xl font-bold text-gray-900">${totalIzin}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Kategori Siswa Bermasalah (30 Hari Terakhir)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${renderKategoriCards()}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Ringkasan Absensi Terbaru</h3>
                        <div class="space-y-3">
                            ${renderLatestAttendanceSummary()}
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Riwayat Kehadiran Guru (3 Hari Terakhir)</h3>
                        <div class="space-y-3">
                            ${renderTeacherAttendanceSummary()}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKategoriCards() {
            const sangat = students.filter(s => s.alpha >= 7).length;
            const perhatian = students.filter(s => s.alpha >= 4 && s.alpha < 7).length;
            const pengawasan = students.filter(s => s.alpha >= 2 && s.alpha < 4).length;
            const baik = students.filter(s => s.alpha < 2).length;

            return `
                <div class="p-4 border-l-4 border-red-500 bg-red-50 cursor-pointer hover:bg-red-100" onclick="showKategoriDetail('sangat')">
                    <p class="text-sm font-medium text-red-800">Sangat Bermasalah</p>
                    <p class="text-2xl font-bold text-red-900">${sangat}</p>
                    <p class="text-xs text-red-600">Alpha ‚â•7 kali</p>
                </div>
                <div class="p-4 border-l-4 border-orange-500 bg-orange-50 cursor-pointer hover:bg-orange-100" onclick="showKategoriDetail('perhatian')">
                    <p class="text-sm font-medium text-orange-800">Perlu Perhatian</p>
                    <p class="text-2xl font-bold text-orange-900">${perhatian}</p>
                    <p class="text-xs text-orange-600">Alpha 4-7 kali</p>
                </div>
                <div class="p-4 border-l-4 border-yellow-500 bg-yellow-50 cursor-pointer hover:bg-yellow-100" onclick="showKategoriDetail('pengawasan')">
                    <p class="text-sm font-medium text-yellow-800">Perlu Pengawasan</p>
                    <p class="text-2xl font-bold text-yellow-900">${pengawasan}</p>
                    <p class="text-xs text-yellow-600">Alpha 2-3 kali</p>
                </div>
                <div class="p-4 border-l-4 border-green-500 bg-green-50 cursor-pointer hover:bg-green-100" onclick="showKategoriDetail('baik')">
                    <p class="text-sm font-medium text-green-800">Baik</p>
                    <p class="text-2xl font-bold text-green-900">${baik}</p>
                    <p class="text-xs text-green-600">Tidak ada alpha</p>
                </div>
            `;
        }

        function renderLatestAttendanceSummary() {
            // Get attendance records from last 5 days only
            const fiveDaysAgo = new Date();
            fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
            
            const recentAttendance = attendanceData
                .filter(record => new Date(record.tanggal) >= fiveDaysAgo)
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))
                .slice(0, 10);

            if (recentAttendance.length === 0) {
                return '<div class="text-center text-gray-500 py-4">Belum ada data absensi dalam 5 hari terakhir</div>';
            }

            // Group by mapel and tanggal
            const groupedAttendance = {};
            recentAttendance.forEach(record => {
                const key = `${record.mapel}-${record.tanggal}`;
                if (!groupedAttendance[key]) {
                    groupedAttendance[key] = {
                        mapel: record.mapel,
                        guru: record.guru,
                        tanggal: record.tanggal,
                        details: []
                    };
                }
                const student = getStudentById(record.siswaId);
                if (student) {
                    groupedAttendance[key].details.push({
                        nama: student.nama,
                        status: record.status
                    });
                }
            });

            const latestAttendance = Object.values(groupedAttendance).slice(0, 3);

            return latestAttendance.map(record => `
                <div class="p-4 border rounded-md bg-gray-50">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-medium text-gray-900">${record.mapel}</p>
                            <p class="text-sm text-gray-600">Guru: ${record.guru}</p>
                        </div>
                        <span class="text-xs text-gray-500">${new Date(record.tanggal).toLocaleDateString('id-ID')}</span>
                    </div>
                    <div class="space-y-1">
                        ${record.details.map(detail => `
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-700">${detail.nama}</span>
                                <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(detail.status)}">${detail.status}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function renderTeacherAttendanceSummary() {
            // Get teacher attendance records from last 3 days only
            const threeDaysAgo = new Date();
            threeDaysAgo.setDate(threeDaysAgo.getDate() - 3);
            
            const recentTeacherAttendance = teacherAttendanceData
                .filter(record => {
                    const recordDate = new Date(record.tanggal);
                    return recordDate >= threeDaysAgo;
                })
                .sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal))
                .slice(0, 5);

            if (recentTeacherAttendance.length === 0) {
                return '<div class="text-center text-gray-500 py-4">Belum ada data kehadiran guru dalam 3 hari terakhir</div>';
            }

            return recentTeacherAttendance.map(record => `
                <div class="p-4 border-l-4 border-green-500 bg-green-50">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p class="font-medium text-green-900">${record.nama}</p>
                            <p class="text-sm text-green-700">${record.mapel} - Kelas ${record.kelas}</p>
                            <p class="text-xs text-green-600">Materi: ${record.materi}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-xs text-green-500">${record.tanggal}</span>
                            <br>
                            <span class="text-xs text-green-500">${record.waktu}</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 mt-2">
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                            <i class="fas fa-map-marker-alt mr-1"></i>GPS
                        </span>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                            <i class="fas fa-camera mr-1"></i>Foto
                        </span>
                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800">
                            <i class="fas fa-check mr-1"></i>Hadir
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderTambahUser() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Tambah Data Pengguna Sistem</h2>
                    <p class="text-gray-600">Buat akun pengguna baru untuk sistem absensi</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-600 mt-1 mr-3"></i>
                            <div class="text-sm text-blue-800">
                                <p class="font-medium mb-1">Informasi Penting:</p>
                                <ul class="list-disc list-inside space-y-1">
                                    <li>Kode akses akan dibuat otomatis setelah data disimpan</li>
                                    <li>Untuk Guru: Wajib mengisi mata pelajaran yang diampu</li>
                                    <li>Untuk Wali Kelas: Wajib mengisi kelas yang diwali</li>
                                    <li>Kode akses dapat digunakan langsung untuk login</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <form onsubmit="addNewUser(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="newUserName" class="block text-sm font-medium text-gray-700 mb-2">
                                    Nama Lengkap <span class="text-red-500">*</span>
                                </label>
                                <input id="newUserName" type="text" required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                                       placeholder="Masukkan nama lengkap">
                            </div>
                            <div>
                                <label for="newUserRole" class="block text-sm font-medium text-gray-700 mb-2">
                                    Role Pengguna <span class="text-red-500">*</span>
                                </label>
                                <select id="newUserRole" required onchange="toggleNewUserAdditionalFields()" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">-- Pilih Role --</option>
                                    <option value="admin">Administrator</option>
                                    <option value="guru">Guru</option>
                                    <option value="wali">Wali Kelas</option>
                                    <option value="kepsek">Kepala Sekolah</option>
                                </select>
                            </div>
                        </div>

                        <div id="newUserAdditionalField" class="hidden">
                            <label id="newUserAdditionalLabel" class="block text-sm font-medium text-gray-700 mb-2"></label>
                            <input id="newUserAdditionalInput" type="text" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>

                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-medium text-gray-900 mb-2">Preview Kode Akses:</h4>
                            <div id="previewKodeAkses" class="text-lg font-mono text-blue-600">
                                Pilih role untuk melihat preview kode akses
                            </div>
                        </div>

                        <div class="flex justify-end space-x-3">
                            <button type="button" onclick="resetNewUserForm()" 
                                    class="px-6 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                                <i class="fas fa-undo mr-2"></i>Reset Form
                            </button>
                            <button type="submit" 
                                    class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                <i class="fas fa-user-plus mr-2"></i>Tambah Pengguna Baru
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Pengguna yang Baru Ditambahkan</h3>
                    <div id="newlyAddedUsers" class="space-y-3">
                        <div class="text-center text-gray-500 py-8">
                            Belum ada pengguna baru yang ditambahkan
                        </div>
                    </div>
                </div>
            `;
        }

        function renderKelolaUser() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Kelola User</h2>
                    <p class="text-gray-600">Kelola dan edit data pengguna sistem yang sudah ada</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Daftar User</h3>
                        <div class="flex space-x-2">
                            <input id="searchUser" type="text" placeholder="Cari user..." class="px-3 py-2 border border-gray-300 rounded-md text-sm" onkeyup="filterUsers()">
                            <select id="filterRole" class="px-3 py-2 border border-gray-300 rounded-md text-sm" onchange="filterUsers()">
                                <option value="">Semua Role</option>
                                <option value="admin">Administrator</option>
                                <option value="guru">Guru</option>
                                <option value="wali">Wali Kelas</option>
                                <option value="kepsek">Kepala Sekolah</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kode Akses</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Role</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detail</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="userTableBody" class="bg-white divide-y divide-gray-200">
                                ${Object.entries(users).map(([code, user]) => `
                                    <tr data-name="${user.name.toLowerCase()}" data-role="${user.role}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${code}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.name}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${getRoleText(user.role)}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${user.mapel || user.kelas || '-'}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editUser('${code}')" class="text-blue-600 hover:text-blue-900 mr-3">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteUser('${code}')" class="text-red-600 hover:text-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderKelolaSiswa() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Kelola Siswa</h2>
                    <p class="text-gray-600">Tambah dan kelola data siswa</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Tambah Siswa Baru</h3>
                    <form onsubmit="addStudent(event)" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="studentName" class="block text-sm font-medium text-gray-700 mb-2">Nama Lengkap</label>
                            <input id="studentName" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="studentNisn" class="block text-sm font-medium text-gray-700 mb-2">NISN</label>
                            <input id="studentNisn" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                        </div>
                        <div>
                            <label for="studentClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                            <select id="studentClass" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Pilih Kelas</option>
                                <option value="X-A">X-A</option>
                                <option value="X-B">X-B</option>
                                <option value="XI-A">XI-A</option>
                                <option value="XI-B">XI-B</option>
                                <option value="XII-A">XII-A</option>
                                <option value="XII-B">XII-B</option>
                            </select>
                        </div>
                        <div>
                            <label for="parentPhone" class="block text-sm font-medium text-gray-700 mb-2">No. HP Orang Tua</label>
                            <input id="parentPhone" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="08xxxxxxxxxx">
                        </div>
                        <div class="md:col-span-2">
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                <i class="fas fa-plus mr-2"></i>Tambah Siswa
                            </button>
                        </div>
                    </form>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Daftar Siswa</h3>
                        <div class="flex space-x-2">
                            <select id="classFilter" onchange="filterStudents()" class="px-3 py-2 border border-gray-300 rounded-md text-sm">
                                <option value="">Semua Kelas</option>
                                <option value="X-A">X-A</option>
                                <option value="X-B">X-B</option>
                                <option value="XI-A">XI-A</option>
                                <option value="XI-B">XI-B</option>
                                <option value="XII-A">XII-A</option>
                                <option value="XII-B">XII-B</option>
                            </select>
                            <button onclick="deleteAllByClass()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 text-sm">
                                <i class="fas fa-trash mr-2"></i>Hapus Berdasarkan Kelas
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. Orang Tua</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="studentTableBody" class="bg-white divide-y divide-gray-200">
                                ${students.map(student => `
                                    <tr data-class="${student.kelas}">
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nisn}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.kelas}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.noOrtu}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.alpha}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editStudent(${student.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteStudent(${student.id})" class="text-red-600 hover:text-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderInputAbsensi() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Input Absensi Siswa</h2>
                    <p class="text-gray-600">Input kehadiran siswa per mata pelajaran</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <form onsubmit="submitAttendance(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="attendanceClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas</label>
                                <select id="attendanceClass" required onchange="updateStudentList()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X-A">X-A</option>
                                    <option value="X-B">X-B</option>
                                    <option value="XI-A">XI-A</option>
                                    <option value="XI-B">XI-B</option>
                                    <option value="XII-A">XII-A</option>
                                    <option value="XII-B">XII-B</option>
                                </select>
                            </div>
                            <div>
                                <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <input id="subject" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Matematika">
                            </div>
                            <div>
                                <label for="attendanceDate" class="block text-sm font-medium text-gray-700 mb-2">Tanggal</label>
                                <input id="attendanceDate" type="date" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                        </div>
                        
                        <div>
                            <label for="material" class="block text-sm font-medium text-gray-700 mb-2">Materi yang Diajarkan</label>
                            <textarea id="material" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan materi yang diajarkan"></textarea>
                        </div>

                        <div>
                            <h4 class="text-md font-medium text-gray-900 mb-4">Daftar Kehadiran Siswa</h4>
                            <div class="space-y-3" id="attendanceList">
                                <div class="text-center text-gray-500 py-8">
                                    Pilih kelas terlebih dahulu untuk menampilkan daftar siswa
                                </div>
                            </div>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                <i class="fas fa-save mr-2"></i>Simpan Absensi
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function updateStudentList() {
            const selectedClass = document.getElementById('attendanceClass').value;
            const attendanceList = document.getElementById('attendanceList');
            
            if (!selectedClass) {
                attendanceList.innerHTML = '<div class="text-center text-gray-500 py-8">Pilih kelas terlebih dahulu untuk menampilkan daftar siswa</div>';
                return;
            }

            const classStudents = getStudentsByClass(selectedClass);
            
            if (classStudents.length === 0) {
                attendanceList.innerHTML = '<div class="text-center text-gray-500 py-8">Tidak ada siswa di kelas ini</div>';
                return;
            }

            attendanceList.innerHTML = classStudents.map(student => `
                <div class="flex items-center justify-between p-3 border rounded-md">
                    <div>
                        <p class="font-medium text-gray-900">${student.nama}</p>
                        <p class="text-sm text-gray-500">NISN: ${student.nisn}</p>
                    </div>
                    <div class="flex space-x-2">
                        <label class="flex items-center">
                            <input type="radio" name="attendance_${student.id}" value="hadir" class="mr-2" checked>
                            <span class="text-sm text-green-600">Hadir</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="attendance_${student.id}" value="izin" class="mr-2">
                            <span class="text-sm text-blue-600">Izin</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="attendance_${student.id}" value="sakit" class="mr-2">
                            <span class="text-sm text-yellow-600">Sakit</span>
                        </label>
                        <label class="flex items-center">
                            <input type="radio" name="attendance_${student.id}" value="alpha" class="mr-2">
                            <span class="text-sm text-red-600">Alpha</span>
                        </label>
                    </div>
                </div>
            `).join('');
        }

        function renderKategoriSiswa() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Kategori Siswa Bermasalah</h2>
                    <p class="text-gray-600">Monitoring siswa berdasarkan tingkat kehadiran (30 hari terakhir)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    ${renderKategoriCards()}
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Detail Siswa Bermasalah</h3>
                        <button onclick="exportToExcel('kategori')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${students.filter(s => s.alpha >= 2).map(student => {
                                    let kategori = '';
                                    let badgeClass = '';
                                    if (student.alpha >= 7) {
                                        kategori = 'Sangat Bermasalah';
                                        badgeClass = 'bg-red-100 text-red-800';
                                    } else if (student.alpha >= 4) {
                                        kategori = 'Perlu Perhatian';
                                        badgeClass = 'bg-orange-100 text-orange-800';
                                    } else {
                                        kategori = 'Perlu Pengawasan';
                                        badgeClass = 'bg-yellow-100 text-yellow-800';
                                    }
                                    
                                    return `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nisn}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.kelas}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.alpha}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full ${badgeClass}">${kategori}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="viewStudentDetail(${student.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button onclick="openWhatsAppModal('${student.noOrtu}', '${student.nama}')" class="text-green-600 hover:text-green-900">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderKirimWA() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Kirim WhatsApp</h2>
                    <p class="text-gray-600">Kirim notifikasi WhatsApp ke orang tua siswa</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Kirim Berdasarkan Kategori</h3>
                        <div class="space-y-4">
                            <div class="p-4 border rounded-md">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-red-800">Sangat Bermasalah (${students.filter(s => s.alpha >= 7).length} siswa)</h4>
                                    <button onclick="sendBulkWA('sangat')" class="px-3 py-1 bg-red-600 text-white rounded text-sm hover:bg-red-700">
                                        <i class="fab fa-whatsapp mr-1"></i>Kirim Semua
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600">Alpha ‚â•7 kali dalam 30 hari</p>
                            </div>
                            
                            <div class="p-4 border rounded-md">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-orange-800">Perlu Perhatian (${students.filter(s => s.alpha >= 4 && s.alpha < 7).length} siswa)</h4>
                                    <button onclick="sendBulkWA('perhatian')" class="px-3 py-1 bg-orange-600 text-white rounded text-sm hover:bg-orange-700">
                                        <i class="fab fa-whatsapp mr-1"></i>Kirim Semua
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600">Alpha 4-7 kali dalam 30 hari</p>
                            </div>
                            
                            <div class="p-4 border rounded-md">
                                <div class="flex justify-between items-center mb-2">
                                    <h4 class="font-medium text-yellow-800">Perlu Pengawasan (${students.filter(s => s.alpha >= 2 && s.alpha < 4).length} siswa)</h4>
                                    <button onclick="sendBulkWA('pengawasan')" class="px-3 py-1 bg-yellow-600 text-white rounded text-sm hover:bg-yellow-700">
                                        <i class="fab fa-whatsapp mr-1"></i>Kirim Semua
                                    </button>
                                </div>
                                <p class="text-sm text-gray-600">Alpha 2-3 kali dalam 30 hari</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Riwayat Notifikasi</h3>
                        <div class="space-y-3" style="max-height: 400px; overflow-y: auto;">
                            ${whatsappHistory.length === 0 ? 
                                '<div class="text-center text-gray-500 py-4">Belum ada riwayat notifikasi</div>' :
                                whatsappHistory.slice(-10).reverse().map(history => `
                                    <div class="p-3 bg-gray-50 rounded-md">
                                        <div class="flex justify-between items-start">
                                            <div>
                                                <p class="font-medium text-gray-900">${history.studentName} - ${getCategoryText(history.category)}</p>
                                                <p class="text-sm text-gray-600">Ke: ${history.phone}</p>
                                            </div>
                                            <span class="text-xs text-gray-500">${history.tanggal}, ${history.waktu}</span>
                                        </div>
                                    </div>
                                `).join('')
                            }
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTemplateWA() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Template WhatsApp</h2>
                    <p class="text-gray-600">Kelola template pesan WhatsApp untuk setiap kategori</p>
                </div>

                <div class="space-y-6">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-red-800 mb-4">Template: Sangat Bermasalah</h3>
                        <textarea id="templateSangat" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${messageTemplates.sangat_bermasalah}</textarea>
                        <button onclick="saveTemplate('sangat')" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Simpan Template
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-orange-800 mb-4">Template: Perlu Perhatian Khusus</h3>
                        <textarea id="templatePerhatian" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${messageTemplates.perlu_perhatian}</textarea>
                        <button onclick="saveTemplate('perhatian')" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Simpan Template
                        </button>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-yellow-800 mb-4">Template: Perlu Pengawasan Khusus</h3>
                        <textarea id="templatePengawasan" rows="4" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${messageTemplates.perlu_pengawasan}</textarea>
                        <button onclick="saveTemplate('pengawasan')" class="mt-3 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Simpan Template
                        </button>
                    </div>
                </div>
            `;
        }

        function renderAbsensiGuru() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Kehadiran Guru</h2>
                    <p class="text-gray-600">Input kehadiran dengan lokasi otomatis dan foto verifikasi</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div id="locationStatus" class="mb-4 p-4 rounded-md bg-yellow-50 border border-yellow-200">
                        <div class="flex items-center">
                            <i class="fas fa-map-marker-alt text-yellow-600 mr-3"></i>
                            <div>
                                <p class="font-medium text-yellow-900">Status Lokasi</p>
                                <p class="text-sm text-yellow-700" id="locationStatusText">Mengambil lokasi perangkat...</p>
                            </div>
                        </div>
                    </div>

                    <form onsubmit="submitTeacherAttendance(event)" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="teacherClass" class="block text-sm font-medium text-gray-700 mb-2">Kelas yang Diajar</label>
                                <select id="teacherClass" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Pilih Kelas</option>
                                    <option value="X-A">X-A</option>
                                    <option value="X-B">X-B</option>
                                    <option value="XI-A">XI-A</option>
                                    <option value="XI-B">XI-B</option>
                                </select>
                            </div>
                            <div>
                                <label for="teacherSubject" class="block text-sm font-medium text-gray-700 mb-2">Mata Pelajaran</label>
                                <input id="teacherSubject" type="text" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Contoh: Matematika">
                            </div>
                        </div>
                        
                        <div>
                            <label for="teacherMaterial" class="block text-sm font-medium text-gray-700 mb-2">Materi yang Diajarkan</label>
                            <textarea id="teacherMaterial" rows="3" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="Masukkan materi yang diajarkan"></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Waktu Otomatis</label>
                                <input type="text" id="currentTime" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" value="">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS <span class="text-red-500">*</span></label>
                                <input type="text" id="currentLocation" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50" value="Mengambil lokasi...">
                                <input type="hidden" id="locationCoords" value="">
                            </div>
                        </div>

                        <div class="bg-blue-50 p-4 rounded-md">
                            <div class="flex items-center mb-3">
                                <i class="fas fa-camera text-blue-600 mr-3"></i>
                                <div>
                                    <p class="font-medium text-blue-900">Foto Kehadiran <span class="text-red-500">*</span></p>
                                    <p class="text-sm text-blue-700">Ambil foto untuk verifikasi kehadiran</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-4">
                                <button type="button" onclick="openCamera()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i class="fas fa-camera mr-2"></i>Buka Kamera
                                </button>
                                <div id="photoStatus" class="text-sm text-gray-600">
                                    Belum ada foto
                                </div>
                            </div>
                            <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display: none;" onchange="handlePhotoCapture(event)">
                            <canvas id="photoCanvas" style="display: none;"></canvas>
                        </div>

                        <div class="flex justify-end">
                            <button type="submit" id="submitAttendanceBtn" disabled class="px-6 py-2 bg-gray-400 text-white rounded-md cursor-not-allowed">
                                <i class="fas fa-check mr-2"></i>Submit Kehadiran
                            </button>
                        </div>
                    </form>
                </div>

                <!-- Video Modal for Camera -->
                <div id="cameraModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
                    <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-semibold">Ambil Foto Kehadiran</h3>
                            <button onclick="closeCameraModal()" class="text-gray-400 hover:text-gray-600">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="text-center">
                            <video id="cameraVideo" width="300" height="200" autoplay style="border-radius: 8px; background: #000;"></video>
                            <div class="mt-4 space-x-2">
                                <button onclick="capturePhoto()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                    <i class="fas fa-camera mr-2"></i>Ambil Foto
                                </button>
                                <button onclick="closeCameraModal()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                                    Batal
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRingkasanSiswa() {
            updateStudentStats();
            
            // Calculate overall statistics
            const totalStudents = students.length;
            const totalAttendanceRecords = attendanceData.length;
            const hadirCount = attendanceData.filter(r => r.status === 'hadir').length;
            const alphaCount = attendanceData.filter(r => r.status === 'alpha').length;
            const sakitCount = attendanceData.filter(r => r.status === 'sakit').length;
            const izinCount = attendanceData.filter(r => r.status === 'izin').length;

            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Ringkasan Kehadiran Siswa</h2>
                    <p class="text-gray-600">Data kehadiran ${totalStudents} siswa secara keseluruhan (${totalAttendanceRecords} record)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Hadir</p>
                                <p class="text-2xl font-bold text-gray-900">${hadirCount}</p>
                                <p class="text-xs text-green-600">${totalAttendanceRecords > 0 ? ((hadirCount / totalAttendanceRecords) * 100).toFixed(1) : 0}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-red-600">
                                <i class="fas fa-times text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Alpha</p>
                                <p class="text-2xl font-bold text-gray-900">${alphaCount}</p>
                                <p class="text-xs text-red-600">${totalAttendanceRecords > 0 ? ((alphaCount / totalAttendanceRecords) * 100).toFixed(1) : 0}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-bed text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Sakit</p>
                                <p class="text-2xl font-bold text-gray-900">${sakitCount}</p>
                                <p class="text-xs text-yellow-600">${totalAttendanceRecords > 0 ? ((sakitCount / totalAttendanceRecords) * 100).toFixed(1) : 0}%</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-info text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Izin</p>
                                <p class="text-2xl font-bold text-gray-900">${izinCount}</p>
                                <p class="text-xs text-blue-600">${totalAttendanceRecords > 0 ? ((izinCount / totalAttendanceRecords) * 100).toFixed(1) : 0}%</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Siswa</h3>
                    <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                        <input id="filterKepsekNama" type="text" placeholder="Nama Siswa" class="px-3 py-2 border border-gray-300 rounded-md" onkeyup="filterKepsekSiswaReal()">
                        <input id="filterKepsekNisn" type="text" placeholder="NISN" class="px-3 py-2 border border-gray-300 rounded-md" onkeyup="filterKepsekSiswaReal()">
                        <select id="filterKepsekKelas" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterKepsekSiswaReal()">
                            <option value="">Semua Kelas</option>
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-A">XI-A</option>
                            <option value="XI-B">XI-B</option>
                            <option value="XII-A">XII-A</option>
                            <option value="XII-B">XII-B</option>
                        </select>
                        <select id="filterKepsekKategori" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterKepsekSiswaReal()">
                            <option value="">Semua Kategori</option>
                            <option value="sangat">Sangat Bermasalah</option>
                            <option value="perhatian">Perlu Perhatian</option>
                            <option value="pengawasan">Perlu Pengawasan</option>
                            <option value="baik">Baik</option>
                        </select>
                        <input id="filterKepsekMinAlpha" type="number" placeholder="Min Alpha" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterKepsekSiswaReal()">
                        <input id="filterKepsekMaxAlpha" type="number" placeholder="Max Alpha" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterKepsekSiswaReal()">
                    </div>
                    <div class="mt-4">
                        <button onclick="resetKepsekSiswaFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="exportKepsekSiswaToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 ml-2">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="printKepsekSiswaReport()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ml-2">
                            <i class="fas fa-print mr-2"></i>Print Laporan
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Kehadiran Siswa</h3>
                        <div class="text-sm text-gray-600">
                            Menampilkan ${students.length} siswa
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hadir</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Izin</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sakit</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Alpha</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kategori</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Persentase</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="kepsekSiswaTable" class="bg-white divide-y divide-gray-200">
                                ${students.map(student => {
                                    const studentAttendance = getAttendanceByStudent(student.id);
                                    const totalRecords = studentAttendance.length || 30; // Default 30 if no records
                                    const hadir = studentAttendance.filter(a => a.status === 'hadir').length;
                                    const persentase = totalRecords > 0 ? ((hadir / totalRecords) * 100).toFixed(1) : 0;
                                    
                                    let kategori = '';
                                    let kategoriBadge = '';
                                    if (student.alpha >= 7) {
                                        kategori = 'Sangat Bermasalah';
                                        kategoriBadge = 'bg-red-100 text-red-800';
                                    } else if (student.alpha >= 4) {
                                        kategori = 'Perlu Perhatian';
                                        kategoriBadge = 'bg-orange-100 text-orange-800';
                                    } else if (student.alpha >= 2) {
                                        kategori = 'Perlu Pengawasan';
                                        kategoriBadge = 'bg-yellow-100 text-yellow-800';
                                    } else {
                                        kategori = 'Baik';
                                        kategoriBadge = 'bg-green-100 text-green-800';
                                    }
                                    
                                    return `
                                        <tr data-name="${student.nama.toLowerCase()}" data-nisn="${student.nisn}" data-class="${student.kelas}" data-alpha="${student.alpha}" data-category="${kategori.toLowerCase()}">
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nisn}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.kelas}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-medium">${hadir}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-blue-600 font-medium">${student.izin}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-yellow-600 font-medium">${student.sakit}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-red-600 font-medium">${student.alpha}</td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full ${kategoriBadge}">${kategori}</span>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium ${persentase >= 80 ? 'text-green-600' : persentase >= 60 ? 'text-yellow-600' : 'text-red-600'}">${persentase}%</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="viewKepsekStudentDetail(${student.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button onclick="openWhatsAppModal('${student.noOrtu}', '${student.nama}')" class="text-green-600 hover:text-green-900">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderAdminRingkasanGuru() {
            const teacherData = [
                { id: 1, nama: 'Budi Santoso', kelas: 'X-A', waktu: '07:30', lokasi: '-6.2088, 106.8456', mapel: 'Matematika', tanggal: '15 Jan 2024', materi: 'Fungsi Linear' },
                { id: 2, nama: 'Siti Nurhaliza', kelas: 'X-B', waktu: '07:25', lokasi: '-6.2088, 106.8456', mapel: 'Bahasa Indonesia', tanggal: '15 Jan 2024', materi: 'Teks Eksposisi' },
                { id: 3, nama: 'Ahmad Wijaya', kelas: 'XI-A', waktu: '07:35', lokasi: '-6.2088, 106.8456', mapel: 'Fisika', tanggal: '15 Jan 2024', materi: 'Gerak Lurus' },
                { id: 4, nama: 'Dewi Sartika', kelas: 'XI-B', waktu: '07:40', lokasi: '-6.2088, 106.8456', mapel: 'Kimia', tanggal: '14 Jan 2024', materi: 'Ikatan Kimia' },
                { id: 5, nama: 'Eko Prasetyo', kelas: 'XII-A', waktu: '07:20', lokasi: '-6.2088, 106.8456', mapel: 'Biologi', tanggal: '14 Jan 2024', materi: 'Genetika' }
            ];

            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Ringkasan Kehadiran Guru (Admin)</h2>
                    <p class="text-gray-600">Kelola data kehadiran guru dengan kontrol penuh</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Guru</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="filterAdminGuruNama" type="text" placeholder="Nama Guru" class="px-3 py-2 border border-gray-300 rounded-md">
                        <select id="filterAdminGuruKelas" class="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Semua Kelas</option>
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-A">XI-A</option>
                            <option value="XI-B">XI-B</option>
                            <option value="XII-A">XII-A</option>
                            <option value="XII-B">XII-B</option>
                        </select>
                        <input id="filterAdminGuruTanggalMulai" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                        <input id="filterAdminGuruTanggalAkhir" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mt-4 flex flex-wrap gap-2">
                        <button onclick="filterAdminGuru()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                        <button onclick="resetAdminGuruFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="addTeacherAttendance()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-plus mr-2"></i>Tambah Data
                        </button>
                        <button onclick="deleteAllTeacherAttendance()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Hapus Semua
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Kehadiran Guru</h3>
                        <button onclick="exportToExcel('admin-guru')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllTeachers" onchange="toggleAllTeachers()" class="mr-2">
                                        Pilih
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Absensi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titik Lokasi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminGuruTable" class="bg-white divide-y divide-gray-200">
                                ${teacherData.map(teacher => `
                                    <tr data-teacher-id="${teacher.id}">
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <input type="checkbox" class="teacher-checkbox" value="${teacher.id}">
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.tanggal}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.nama}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.mapel}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.kelas}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.waktu}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.lokasi}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.materi}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Hadir</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="editTeacherAttendance(${teacher.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button onclick="deleteTeacherAttendance(${teacher.id})" class="text-red-600 hover:text-red-900">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <button onclick="deleteSelectedTeachers()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-400" id="deleteSelectedBtn" disabled>
                                <i class="fas fa-trash mr-2"></i>Hapus Terpilih
                            </button>
                            <button onclick="editSelectedTeachers()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 disabled:bg-gray-400" id="editSelectedBtn" disabled>
                                <i class="fas fa-edit mr-2"></i>Edit Terpilih
                            </button>
                        </div>
                        <div class="text-sm text-gray-600">
                            Total: ${teacherData.length} data kehadiran guru
                        </div>
                    </div>
                </div>
            `;
        }

        function renderRingkasanGuru() {
            const teacherData = [
                { nama: 'Budi Santoso', kelas: 'X-A', waktu: '07:30', lokasi: '-6.2088, 106.8456', mapel: 'Matematika', tanggal: '15 Jan 2024' },
                { nama: 'Siti Nurhaliza', kelas: 'X-B', waktu: '07:25', lokasi: '-6.2088, 106.8456', mapel: 'Bahasa Indonesia', tanggal: '15 Jan 2024' },
                { nama: 'Ahmad Wijaya', kelas: 'XI-A', waktu: '07:35', lokasi: '-6.2088, 106.8456', mapel: 'Fisika', tanggal: '15 Jan 2024' },
                { nama: 'Dewi Sartika', kelas: 'XI-B', waktu: '07:40', lokasi: '-6.2088, 106.8456', mapel: 'Kimia', tanggal: '14 Jan 2024' },
                { nama: 'Eko Prasetyo', kelas: 'XII-A', waktu: '07:20', lokasi: '-6.2088, 106.8456', mapel: 'Biologi', tanggal: '14 Jan 2024' }
            ];

            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Ringkasan Kehadiran Guru</h2>
                    <p class="text-gray-600">Data kehadiran guru dengan filter pencarian</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Guru</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="filterKepsekGuruNama" type="text" placeholder="Nama Guru" class="px-3 py-2 border border-gray-300 rounded-md">
                        <select id="filterKepsekGuruKelas" class="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Semua Kelas</option>
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-A">XI-A</option>
                            <option value="XI-B">XI-B</option>
                            <option value="XII-A">XII-A</option>
                            <option value="XII-B">XII-B</option>
                        </select>
                        <input id="filterKepsekGuruTanggalMulai" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                        <input id="filterKepsekGuruTanggalAkhir" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mt-4">
                        <button onclick="filterKepsekGuru()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                        <button onclick="resetKepsekGuruFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 ml-2">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Kehadiran Guru</h3>
                        <button onclick="exportToExcel('guru')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu Absensi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Titik Lokasi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="kepsekGuruTable" class="bg-white divide-y divide-gray-200">
                                ${teacherData.map(teacher => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.tanggal}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${teacher.nama}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.mapel}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.kelas}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.waktu}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${teacher.lokasi}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Hadir</span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Additional render functions for other menus
        function renderLaporanAbsensi() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Laporan Absensi</h2>
                    <p class="text-gray-600">Kelola dan export laporan absensi</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Laporan</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <input type="text" placeholder="Nama Siswa" class="px-3 py-2 border border-gray-300 rounded-md">
                        <select class="px-3 py-2 border border-gray-300 rounded-md">
                            <option>Semua Kelas</option>
                            <option>X-A</option>
                            <option>X-B</option>
                        </select>
                        <input type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                        <button class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="exportToExcel('laporan')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="deleteAllAttendance()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">
                            <i class="fas fa-trash mr-2"></i>Hapus Semua
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Data Absensi</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${attendanceData.length === 0 ? 
                                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data absensi</td></tr>' :
                                    attendanceData.slice().reverse().map(record => {
                                        const student = getStudentById(record.siswaId);
                                        return `
                                            <tr>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(record.tanggal).toLocaleDateString('id-ID')}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student?.nama || 'Siswa Tidak Ditemukan'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student?.nisn || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student?.kelas || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(record.status)}">${record.status}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="editAttendanceRecord(${record.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteAttendanceRecord(${record.id})" class="text-red-600 hover:text-red-900">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderAbsensiSiswa() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Absensi Siswa</h2>
                    <p class="text-gray-600">Monitoring absensi siswa secara real-time</p>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Absensi</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="filterAdminNama" type="text" placeholder="Nama Siswa" class="px-3 py-2 border border-gray-300 rounded-md">
                        <input id="filterAdminNisn" type="text" placeholder="NISN" class="px-3 py-2 border border-gray-300 rounded-md">
                        <input id="filterAdminTanggalMulai" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                        <input id="filterAdminTanggalAkhir" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                    </div>
                    <div class="mt-4">
                        <button onclick="filterAdminAbsensi()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                        <button onclick="resetAdminFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 ml-2">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="deleteAllAttendance()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 ml-2">
                            <i class="fas fa-trash mr-2"></i>Hapus Semua
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Absensi Detail</h3>
                        <button onclick="exportToExcel('admin-absensi')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminAbsensiTable" class="bg-white divide-y divide-gray-200">
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">15 Jan 2024</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Ahmad Rizki</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1234567890</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">X-A</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Matematika</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Pak Budi</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-red-100 text-red-800">Alpha</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="editAttendance(1)" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteAttendance(1)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">15 Jan 2024</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Siti Aminah</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1234567891</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">X-A</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Bahasa Indonesia</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Bu Siti</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800">Sakit</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="editAttendance(2)" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteAttendance(2)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">14 Jan 2024</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">Budi Hartono</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">1234567892</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">X-B</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Fisika</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">Pak Ahmad</td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">Izin</span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                        <button onclick="editAttendance(3)" class="text-blue-600 hover:text-blue-900 mr-3">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button onclick="deleteAttendance(3)" class="text-red-600 hover:text-red-900">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Absensi Harian Otomatis</h3>
                        <button onclick="exportToExcel('harian')" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Harian
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Siswa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status Harian</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${students.slice(0, 3).map(student => `
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">15 Jan 2024</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student.nama}</td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student.nisn}</td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">Hadir</span>
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                            <button onclick="viewDailyDetail(${student.id})" class="text-blue-600 hover:text-blue-900">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderRekapAbsensi() {
            // Get attendance data for current teacher
            const teacherAttendanceRecords = attendanceData.filter(record => record.guru === currentUser.name);
            
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Rekapan Absensi Saya</h2>
                    <p class="text-gray-600">Riwayat absensi yang telah Anda input (${teacherAttendanceRecords.length} record)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-chalkboard-teacher text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Mengajar</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.filter(t => t.nama === currentUser.name).length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Siswa Diinput</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceRecords.length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-red-100 text-red-600">
                                <i class="fas fa-exclamation-triangle text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Alpha Tercatat</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceRecords.filter(r => r.status === 'alpha').length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-yellow-100 text-yellow-600">
                                <i class="fas fa-calendar-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hari Aktif</p>
                                <p class="text-2xl font-bold text-gray-900">${new Set(teacherAttendanceRecords.map(r => r.tanggal)).size}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Riwayat</h3>
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                        <input id="filterGuruNama" type="text" placeholder="Nama Siswa" class="px-3 py-2 border border-gray-300 rounded-md" onkeyup="filterGuruAttendanceReal()">
                        <select id="filterGuruKelas" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterGuruAttendanceReal()">
                            <option value="">Semua Kelas</option>
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-A">XI-A</option>
                            <option value="XI-B">XI-B</option>
                            <option value="XII-A">XII-A</option>
                            <option value="XII-B">XII-B</option>
                        </select>
                        <input id="filterGuruTanggalMulai" type="date" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterGuruAttendanceReal()">
                        <input id="filterGuruTanggalAkhir" type="date" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterGuruAttendanceReal()">
                        <button onclick="resetGuruFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Absensi Detail</h3>
                        <div class="flex space-x-2">
                            <button onclick="exportGuruAttendanceToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                                <i class="fas fa-file-excel mr-2"></i>Export Excel
                            </button>
                            <button onclick="printGuruAttendance()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                                <i class="fas fa-print mr-2"></i>Print
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="guruAttendanceTable" class="bg-white divide-y divide-gray-200">
                                ${teacherAttendanceRecords.length === 0 ? 
                                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada data absensi yang Anda input</td></tr>' :
                                    teacherAttendanceRecords.slice().reverse().map(record => {
                                        const student = getStudentById(record.siswaId);
                                        return `
                                            <tr data-student-name="${student?.nama.toLowerCase() || ''}" data-class="${student?.kelas || ''}" data-date="${record.tanggal}">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(record.tanggal).toLocaleDateString('id-ID')}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student?.kelas || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student?.nama || 'Siswa Tidak Ditemukan'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(record.status)}">${record.status}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.keterangan || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="editGuruAttendanceRecord(${record.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                        <i class="fas fa-edit"></i>
                                                    </button>
                                                    <button onclick="deleteGuruAttendanceRecord(${record.id})" class="text-red-600 hover:text-red-900">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Aktivitas Mengajar Terbaru (5 Hari Terakhir)</h3>
                    <div class="space-y-4">
                        ${(() => {
                            const fiveDaysAgo = new Date();
                            fiveDaysAgo.setDate(fiveDaysAgo.getDate() - 5);
                            
                            const recentActivities = teacherAttendanceData
                                .filter(t => t.nama === currentUser.name && new Date(t.tanggal) >= fiveDaysAgo)
                                .slice(-5)
                                .reverse();
                            
                            if (recentActivities.length === 0) {
                                return '<div class="text-center text-gray-500 py-4">Belum ada aktivitas mengajar dalam 5 hari terakhir</div>';
                            }
                            
                            return recentActivities.map(activity => `
                                <div class="p-4 border-l-4 border-blue-500 bg-blue-50">
                                    <div class="flex justify-between items-start">
                                        <div>
                                            <p class="font-medium text-blue-900">${activity.mapel} - Kelas ${activity.kelas}</p>
                                            <p class="text-sm text-blue-700">Materi: ${activity.materi}</p>
                                            <p class="text-xs text-blue-600">Lokasi: ${activity.lokasi}</p>
                                        </div>
                                        <span class="text-xs text-blue-500">${activity.tanggal}, ${activity.waktu}</span>
                                    </div>
                                </div>
                            `).join('');
                        })()}
                    </div>
                </div>
            `;
        }

        function renderAbsensiKelas() {
            // Get class students based on current user's class
            const waliKelas = currentUser.kelas || 'X-A';
            const classStudents = getStudentsByClass(waliKelas);
            const classAttendanceRecords = attendanceData.filter(record => {
                const student = getStudentById(record.siswaId);
                return student && student.kelas === waliKelas;
            });

            // Calculate statistics
            const totalRecords = classAttendanceRecords.length;
            const hadirCount = classAttendanceRecords.filter(r => r.status === 'hadir').length;
            const alphaCount = classAttendanceRecords.filter(r => r.status === 'alpha').length;
            const sakitCount = classAttendanceRecords.filter(r => r.status === 'sakit').length;
            const izinCount = classAttendanceRecords.filter(r => r.status === 'izin').length;

            const hadirPercentage = totalRecords > 0 ? ((hadirCount / totalRecords) * 100).toFixed(1) : 0;
            const alphaPercentage = totalRecords > 0 ? ((alphaCount / totalRecords) * 100).toFixed(1) : 0;
            const sakitPercentage = totalRecords > 0 ? ((sakitCount / totalRecords) * 100).toFixed(1) : 0;
            const izinPercentage = totalRecords > 0 ? ((izinCount / totalRecords) * 100).toFixed(1) : 0;

            // Calculate category counts
            const sangat = classStudents.filter(s => s.alpha >= 7).length;
            const perhatian = classStudents.filter(s => s.alpha >= 4 && s.alpha < 7).length;
            const pengawasan = classStudents.filter(s => s.alpha >= 2 && s.alpha < 4).length;

            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Absensi Kelas ${waliKelas}</h2>
                    <p class="text-gray-600">Monitoring absensi ${classStudents.length} siswa di kelas yang Anda wali</p>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Statistik Kehadiran (Real Data)</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Hadir</span>
                                <span class="font-bold text-green-600">${hadirPercentage}% (${hadirCount})</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Alpha</span>
                                <span class="font-bold text-red-600">${alphaPercentage}% (${alphaCount})</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Sakit</span>
                                <span class="font-bold text-yellow-600">${sakitPercentage}% (${sakitCount})</span>
                            </div>
                            <div class="flex justify-between items-center">
                                <span class="text-gray-600">Total Izin</span>
                                <span class="font-bold text-blue-600">${izinPercentage}% (${izinCount})</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow-sm border p-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Kategori Siswa Bermasalah</h3>
                        <div class="space-y-2">
                            <div class="flex justify-between items-center p-2 bg-red-50 rounded cursor-pointer hover:bg-red-100" onclick="showWaliKategoriDetail('sangat')">
                                <span class="text-red-800">Sangat Bermasalah</span>
                                <span class="font-bold text-red-900">${sangat} siswa</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-orange-50 rounded cursor-pointer hover:bg-orange-100" onclick="showWaliKategoriDetail('perhatian')">
                                <span class="text-orange-800">Perlu Perhatian</span>
                                <span class="font-bold text-orange-900">${perhatian} siswa</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-yellow-50 rounded cursor-pointer hover:bg-yellow-100" onclick="showWaliKategoriDetail('pengawasan')">
                                <span class="text-yellow-800">Perlu Pengawasan</span>
                                <span class="font-bold text-yellow-900">${pengawasan} siswa</span>
                            </div>
                            <div class="flex justify-between items-center p-2 bg-green-50 rounded cursor-pointer hover:bg-green-100" onclick="showWaliKategoriDetail('baik')">
                                <span class="text-green-800">Baik</span>
                                <span class="font-bold text-green-900">${classStudents.filter(s => s.alpha < 2).length} siswa</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Absensi</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="filterWaliNama" type="text" placeholder="Nama Siswa" class="px-3 py-2 border border-gray-300 rounded-md" onkeyup="filterWaliAttendanceReal()">
                        <select id="filterWaliMapel" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterWaliAttendanceReal()">
                            <option value="">Semua Mata Pelajaran</option>
                            <option value="Matematika">Matematika</option>
                            <option value="Bahasa Indonesia">Bahasa Indonesia</option>
                            <option value="Fisika">Fisika</option>
                            <option value="Kimia">Kimia</option>
                            <option value="Biologi">Biologi</option>
                            <option value="Sejarah">Sejarah</option>
                            <option value="Geografi">Geografi</option>
                        </select>
                        <input id="filterWaliTanggalMulai" type="date" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterWaliAttendanceReal()">
                        <input id="filterWaliTanggalAkhir" type="date" class="px-3 py-2 border border-gray-300 rounded-md" onchange="filterWaliAttendanceReal()">
                    </div>
                    <div class="mt-4">
                        <button onclick="resetWaliFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="exportWaliAttendanceToExcel()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 ml-2">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="sendBulkWAToClass()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 ml-2">
                            <i class="fab fa-whatsapp mr-2"></i>Kirim WA Massal
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Detail Absensi Per Mata Pelajaran</h3>
                        <div class="text-sm text-gray-600">
                            Total: ${classAttendanceRecords.length} record absensi
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Siswa</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NISN</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="waliAttendanceTable" class="bg-white divide-y divide-gray-200">
                                ${classAttendanceRecords.length === 0 ? 
                                    '<tr><td colspan="8" class="px-6 py-4 text-center text-gray-500">Belum ada data absensi untuk kelas ini</td></tr>' :
                                    classAttendanceRecords.slice().reverse().map(record => {
                                        const student = getStudentById(record.siswaId);
                                        return `
                                            <tr data-student-name="${student?.nama.toLowerCase() || ''}" data-subject="${record.mapel}" data-date="${record.tanggal}">
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${new Date(record.tanggal).toLocaleDateString('id-ID')}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${student?.nama || 'Siswa Tidak Ditemukan'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${student?.nisn || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.guru}</td>
                                                <td class="px-6 py-4 whitespace-nowrap">
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(record.status)}">${record.status}</span>
                                                </td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.keterangan || '-'}</td>
                                                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                    <button onclick="viewWaliStudentDetail(${student?.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button onclick="openWhatsAppModal('${student?.noOrtu}', '${student?.nama}')" class="text-green-600 hover:text-green-900">
                                                        <i class="fab fa-whatsapp"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        `;
                                    }).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        // Utility functions
        function getStatusBadge(status) {
            const badges = {
                hadir: 'bg-green-100 text-green-800',
                alpha: 'bg-red-100 text-red-800',
                sakit: 'bg-yellow-100 text-yellow-800',
                izin: 'bg-blue-100 text-blue-800'
            };
            return badges[status] || 'bg-gray-100 text-gray-800';
        }

        // Global variable to track newly added users
        let newlyAddedUsers = [];

        // Event handlers
        function addUser(event) {
            event.preventDefault();
            const name = document.getElementById('userName').value.trim();
            const role = document.getElementById('userRole').value;
            const additionalValue = document.getElementById('additionalInput').value.trim();
            
            if (!name || !role) {
                showNotification('Nama dan role harus diisi', 'error');
                return;
            }
            
            // Validate additional fields
            if ((role === 'guru' || role === 'wali') && !additionalValue) {
                const fieldName = role === 'guru' ? 'Mata Pelajaran' : 'Kelas Wali';
                showNotification(`${fieldName} harus diisi untuk role ${getRoleText(role)}`, 'error');
                return;
            }
            
            // Generate unique access code based on existing users count
            const rolePrefix = role.toUpperCase();
            const existingCodes = Object.keys(users).filter(k => k.startsWith(rolePrefix));
            const nextNumber = existingCodes.length + 1;
            const code = rolePrefix + String(nextNumber).padStart(3, '0');
            
            // Check if code already exists (safety check)
            if (users[code]) {
                showNotification('Kode akses sudah ada, coba lagi', 'error');
                return;
            }
            
            const newUser = { role, name };
            
            // Add additional fields based on role
            if (role === 'guru' && additionalValue) {
                newUser.mapel = additionalValue;
            } else if (role === 'wali' && additionalValue) {
                newUser.kelas = additionalValue;
            }
            
            // Add user to the users object
            users[code] = newUser;
            
            showNotification(`‚úÖ User berhasil ditambahkan!\nüë§ Nama: ${name}\nüîë Kode Akses: ${code}\nüìã Role: ${getRoleText(role)}${additionalValue ? '\nüìö Detail: ' + additionalValue : ''}`, 'success');
            
            // Reset form
            document.getElementById('userName').value = '';
            document.getElementById('userRole').value = '';
            document.getElementById('additionalInput').value = '';
            document.getElementById('additionalField').classList.add('hidden');
            
            // Refresh the user list to show new data
            showContent('kelola-user');
        }

        function addNewUser(event) {
            event.preventDefault();
            const name = document.getElementById('newUserName').value.trim();
            const role = document.getElementById('newUserRole').value;
            const additionalValue = document.getElementById('newUserAdditionalInput').value.trim();
            
            if (!name || !role) {
                showNotification('Nama lengkap dan role pengguna harus diisi!', 'error');
                return;
            }
            
            // Validate additional fields
            if ((role === 'guru' || role === 'wali') && !additionalValue) {
                const fieldName = role === 'guru' ? 'Mata Pelajaran' : 'Kelas Wali';
                showNotification(`${fieldName} harus diisi untuk role ${getRoleText(role)}!`, 'error');
                return;
            }
            
            // Generate unique access code
            const rolePrefix = role.toUpperCase();
            const existingCodes = Object.keys(users).filter(k => k.startsWith(rolePrefix));
            const nextNumber = existingCodes.length + 1;
            const code = rolePrefix + String(nextNumber).padStart(3, '0');
            
            // Safety check for duplicate codes
            if (users[code]) {
                // Find next available number
                let safeNumber = nextNumber;
                let safeCode = code;
                while (users[safeCode]) {
                    safeNumber++;
                    safeCode = rolePrefix + String(safeNumber).padStart(3, '0');
                }
                code = safeCode;
            }
            
            const newUser = { role, name };
            
            // Add additional fields based on role
            if (role === 'guru' && additionalValue) {
                newUser.mapel = additionalValue;
            } else if (role === 'wali' && additionalValue) {
                newUser.kelas = additionalValue;
            }
            
            // Add user to the users object
            users[code] = newUser;
            
            // Add to newly added users list for display
            const newUserData = {
                code: code,
                name: name,
                role: role,
                roleText: getRoleText(role),
                additional: additionalValue,
                timestamp: new Date().toLocaleString('id-ID')
            };
            newlyAddedUsers.unshift(newUserData);
            
            // Update the newly added users display
            updateNewlyAddedUsersDisplay();
            
            showNotification(`‚úÖ Pengguna baru berhasil ditambahkan!\n\nüë§ Nama: ${name}\nüîë Kode Akses: ${code}\nüìã Role: ${getRoleText(role)}${additionalValue ? '\nüìö Detail: ' + additionalValue : ''}\n\nüí° Kode akses dapat langsung digunakan untuk login!`, 'success');
            
            // Reset form
            resetNewUserForm();
        }

        function toggleNewUserAdditionalFields() {
            const role = document.getElementById('newUserRole').value;
            const additionalField = document.getElementById('newUserAdditionalField');
            const additionalLabel = document.getElementById('newUserAdditionalLabel');
            const additionalInput = document.getElementById('newUserAdditionalInput');
            const previewDiv = document.getElementById('previewKodeAkses');
            
            if (role === 'guru') {
                additionalField.classList.remove('hidden');
                additionalLabel.innerHTML = 'Mata Pelajaran <span class="text-red-500">*</span>';
                additionalInput.placeholder = 'Contoh: Matematika, Fisika, Bahasa Indonesia';
                additionalInput.required = true;
            } else if (role === 'wali') {
                additionalField.classList.remove('hidden');
                additionalLabel.innerHTML = 'Kelas Wali <span class="text-red-500">*</span>';
                additionalInput.placeholder = 'Contoh: X-A, XI-B, XII-IPA-1';
                additionalInput.required = true;
            } else {
                additionalField.classList.add('hidden');
                additionalInput.required = false;
                additionalInput.value = '';
            }
            
            // Update preview kode akses
            if (role) {
                const rolePrefix = role.toUpperCase();
                const existingCodes = Object.keys(users).filter(k => k.startsWith(rolePrefix));
                const nextNumber = existingCodes.length + 1;
                const previewCode = rolePrefix + String(nextNumber).padStart(3, '0');
                previewDiv.textContent = previewCode;
            } else {
                previewDiv.textContent = 'Pilih role untuk melihat preview kode akses';
            }
        }

        function resetNewUserForm() {
            document.getElementById('newUserName').value = '';
            document.getElementById('newUserRole').value = '';
            document.getElementById('newUserAdditionalInput').value = '';
            document.getElementById('newUserAdditionalField').classList.add('hidden');
            document.getElementById('previewKodeAkses').textContent = 'Pilih role untuk melihat preview kode akses';
        }

        function updateNewlyAddedUsersDisplay() {
            const container = document.getElementById('newlyAddedUsers');
            if (!container) return;
            
            if (newlyAddedUsers.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 py-8">
                        Belum ada pengguna baru yang ditambahkan
                    </div>
                `;
                return;
            }
            
            container.innerHTML = newlyAddedUsers.slice(0, 10).map(user => `
                <div class="p-4 border border-green-200 bg-green-50 rounded-lg">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3 mb-2">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-user-check text-green-600"></i>
                                    <span class="font-medium text-green-900">${user.name}</span>
                                </div>
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">${user.roleText}</span>
                            </div>
                            <div class="text-sm text-green-700 space-y-1">
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-key text-green-600"></i>
                                    <span>Kode Akses: <strong class="font-mono">${user.code}</strong></span>
                                </div>
                                ${user.additional ? `
                                    <div class="flex items-center space-x-2">
                                        <i class="fas fa-info-circle text-green-600"></i>
                                        <span>${user.role === 'guru' ? 'Mata Pelajaran' : 'Kelas Wali'}: <strong>${user.additional}</strong></span>
                                    </div>
                                ` : ''}
                                <div class="flex items-center space-x-2">
                                    <i class="fas fa-clock text-green-600"></i>
                                    <span>Ditambahkan: ${user.timestamp}</span>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <button onclick="copyAccessCode('${user.code}')" class="px-3 py-1 text-xs bg-blue-600 text-white rounded hover:bg-blue-700" title="Copy Kode Akses">
                                <i class="fas fa-copy"></i>
                            </button>
                            <button onclick="removeNewlyAddedUser('${user.code}')" class="px-3 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700" title="Hapus dari Daftar">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function copyAccessCode(code) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(code).then(() => {
                    showNotification(`Kode akses ${code} berhasil disalin ke clipboard!`, 'success');
                }).catch(() => {
                    showNotification('Gagal menyalin kode akses', 'error');
                });
            } else {
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = code;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showNotification(`Kode akses ${code} berhasil disalin!`, 'success');
                } catch (err) {
                    showNotification('Gagal menyalin kode akses', 'error');
                }
                document.body.removeChild(textArea);
            }
        }

        function removeNewlyAddedUser(code) {
            newlyAddedUsers = newlyAddedUsers.filter(user => user.code !== code);
            updateNewlyAddedUsersDisplay();
            showNotification('User dihapus dari daftar tampilan', 'info');
        }

        function toggleAdditionalFields() {
            const role = document.getElementById('userRole').value;
            const additionalField = document.getElementById('additionalField');
            const additionalLabel = document.getElementById('additionalLabel');
            const additionalInput = document.getElementById('additionalInput');
            
            if (role === 'guru') {
                additionalField.classList.remove('hidden');
                additionalLabel.textContent = 'Mata Pelajaran';
                additionalInput.placeholder = 'Contoh: Matematika';
                additionalInput.required = true;
            } else if (role === 'wali') {
                additionalField.classList.remove('hidden');
                additionalLabel.textContent = 'Kelas Wali';
                additionalInput.placeholder = 'Contoh: X-A';
                additionalInput.required = true;
            } else {
                additionalField.classList.add('hidden');
                additionalInput.required = false;
            }
        }

        function editUser(code) {
            const user = users[code];
            if (!user) {
                showNotification('User tidak ditemukan', 'error');
                return;
            }
            
            const newName = prompt(`Edit nama user:\nNama saat ini: ${user.name}`, user.name);
            if (newName && newName.trim() !== '') {
                user.name = newName.trim();
                
                if (user.role === 'guru') {
                    const newMapel = prompt(`Edit mata pelajaran:\nMata pelajaran saat ini: ${user.mapel || 'Belum diset'}`, user.mapel || '');
                    if (newMapel !== null) {
                        user.mapel = newMapel.trim();
                    }
                } else if (user.role === 'wali') {
                    const newKelas = prompt(`Edit kelas wali:\nKelas saat ini: ${user.kelas || 'Belum diset'}`, user.kelas || '');
                    if (newKelas !== null) {
                        user.kelas = newKelas.trim();
                    }
                }
                
                showNotification('Data user berhasil diupdate', 'success');
                showContent('kelola-user');
            }
        }

        function filterUsers() {
            const searchTerm = document.getElementById('searchUser').value.toLowerCase();
            const roleFilter = document.getElementById('filterRole').value;
            const rows = document.querySelectorAll('#userTableBody tr[data-name]');
            
            rows.forEach(row => {
                const name = row.dataset.name || '';
                const role = row.dataset.role || '';
                
                let show = true;
                
                // Filter by search term
                if (searchTerm && !name.includes(searchTerm)) {
                    show = false;
                }
                
                // Filter by role
                if (roleFilter && role !== roleFilter) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        function deleteUser(code) {
            if (confirm('Yakin ingin menghapus user ini?')) {
                delete users[code];
                showNotification('User berhasil dihapus', 'success');
                showContent('kelola-user');
            }
        }

        function addStudent(event) {
            event.preventDefault();
            const nama = document.getElementById('studentName').value;
            const nisn = document.getElementById('studentNisn').value;
            const kelas = document.getElementById('studentClass').value;
            const noOrtu = document.getElementById('parentPhone').value;
            
            // Check if NISN already exists
            if (students.find(s => s.nisn === nisn)) {
                showNotification('NISN sudah terdaftar', 'error');
                return;
            }
            
            const newStudent = {
                id: nextStudentId++,
                nama,
                nisn,
                kelas,
                noOrtu,
                alpha: 0,
                sakit: 0,
                izin: 0
            };
            
            students.push(newStudent);
            showNotification(`Siswa ${nama} berhasil ditambahkan`, 'success');
            
            // Reset form
            document.getElementById('studentName').value = '';
            document.getElementById('studentNisn').value = '';
            document.getElementById('studentClass').value = '';
            document.getElementById('parentPhone').value = '';
            
            showContent('kelola-siswa');
        }

        function deleteStudent(id) {
            if (confirm('Yakin ingin menghapus siswa ini?')) {
                const index = students.findIndex(s => s.id === id);
                if (index > -1) {
                    students.splice(index, 1);
                    showNotification('Siswa berhasil dihapus', 'success');
                    showContent('kelola-siswa');
                }
            }
        }

        function filterStudents() {
            const classFilter = document.getElementById('classFilter').value;
            const rows = document.querySelectorAll('#studentTableBody tr');
            
            rows.forEach(row => {
                if (!classFilter || row.dataset.class === classFilter) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function deleteAllByClass() {
            const classFilter = document.getElementById('classFilter').value;
            if (!classFilter) {
                alert('Pilih kelas terlebih dahulu');
                return;
            }
            
            if (confirm(`Yakin ingin menghapus semua siswa kelas ${classFilter}?`)) {
                const initialLength = students.length;
                for (let i = students.length - 1; i >= 0; i--) {
                    if (students[i].kelas === classFilter) {
                        students.splice(i, 1);
                    }
                }
                const deletedCount = initialLength - students.length;
                showNotification(`${deletedCount} siswa berhasil dihapus`, 'success');
                showContent('kelola-siswa');
            }
        }

        function submitAttendance(event) {
            event.preventDefault();
            
            const kelas = document.getElementById('attendanceClass').value;
            const mapel = document.getElementById('subject').value;
            const tanggal = document.getElementById('attendanceDate').value;
            const materi = document.getElementById('material').value;
            const guru = currentUser.name;

            if (!kelas) {
                showNotification('Pilih kelas terlebih dahulu', 'error');
                return;
            }

            const classStudents = getStudentsByClass(kelas);
            let savedCount = 0;

            classStudents.forEach(student => {
                const statusInput = document.querySelector(`input[name="attendance_${student.id}"]:checked`);
                if (statusInput) {
                    const status = statusInput.value;
                    addAttendanceRecord(student.id, tanggal, status, mapel, guru, materi);
                    savedCount++;
                }
            });

            // Add teacher attendance record
            const now = new Date();
            const waktu = now.toLocaleTimeString('id-ID');
            const lokasi = 'Sekolah'; // Default location
            addTeacherAttendanceRecord(guru, kelas, mapel, materi, waktu, lokasi);

            showNotification(`Absensi ${savedCount} siswa berhasil disimpan`, 'success');
            
            // Reset form
            document.getElementById('attendanceClass').value = '';
            document.getElementById('subject').value = '';
            document.getElementById('material').value = '';
            updateStudentList();
        }

        function submitTeacherAttendance(event) {
            event.preventDefault();
            
            if (!locationObtained) {
                showNotification('Lokasi GPS harus diperoleh terlebih dahulu sebelum submit kehadiran', 'error');
                return;
            }
            
            if (!photoTaken) {
                showNotification('Foto kehadiran harus diambil terlebih dahulu', 'error');
                return;
            }
            
            const kelas = document.getElementById('teacherClass').value;
            const mapel = document.getElementById('teacherSubject').value;
            const materi = document.getElementById('teacherMaterial').value;
            const lokasi = document.getElementById('currentLocation').value;
            const waktu = document.getElementById('currentTime').value;
            
            // Add teacher attendance record
            addTeacherAttendanceRecord(currentUser.name, kelas, mapel, materi, waktu, lokasi);
            
            showNotification('Kehadiran guru berhasil dicatat dengan lokasi dan foto verifikasi', 'success');
            
            // Reset form
            document.getElementById('teacherClass').value = '';
            document.getElementById('teacherSubject').value = '';
            document.getElementById('teacherMaterial').value = '';
            
            // Reset photo and location status
            photoTaken = false;
            locationObtained = false;
            document.getElementById('photoStatus').textContent = 'Belum ada foto';
            document.getElementById('submitAttendanceBtn').disabled = true;
            document.getElementById('submitAttendanceBtn').className = 'px-6 py-2 bg-gray-400 text-white rounded-md cursor-not-allowed';
            
            // Get location again for next submission
            setTimeout(getCurrentLocation, 1000);
        }

        // Camera and location functions
        let currentStream = null;
        let locationObtained = false;
        let photoTaken = false;

        function openCamera() {
            // Try to open device camera first
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                document.getElementById('cameraModal').classList.remove('hidden');
                
                navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    } 
                })
                .then(function(stream) {
                    currentStream = stream;
                    const video = document.getElementById('cameraVideo');
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(err) {
                    console.log('Camera error:', err);
                    // Fallback to file input
                    closeCameraModal();
                    document.getElementById('cameraInput').click();
                });
            } else {
                // Fallback to file input for older browsers
                document.getElementById('cameraInput').click();
            }
        }

        function capturePhoto() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.getElementById('photoCanvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            // Convert to blob and store
            canvas.toBlob(function(blob) {
                photoTaken = true;
                document.getElementById('photoStatus').innerHTML = '<i class="fas fa-check text-green-600 mr-2"></i>Foto berhasil diambil';
                checkFormReadiness();
                closeCameraModal();
                showNotification('Foto kehadiran berhasil diambil', 'success');
            }, 'image/jpeg', 0.8);
        }

        function closeCameraModal() {
            if (currentStream) {
                currentStream.getTracks().forEach(track => track.stop());
                currentStream = null;
            }
            document.getElementById('cameraModal').classList.add('hidden');
        }

        function handlePhotoCapture(event) {
            const file = event.target.files[0];
            if (file) {
                photoTaken = true;
                document.getElementById('photoStatus').innerHTML = '<i class="fas fa-check text-green-600 mr-2"></i>Foto berhasil dipilih';
                checkFormReadiness();
                showNotification('Foto kehadiran berhasil dipilih', 'success');
            }
        }

        function checkFormReadiness() {
            const submitBtn = document.getElementById('submitAttendanceBtn');
            if (locationObtained && photoTaken && submitBtn) {
                submitBtn.disabled = false;
                submitBtn.className = 'px-6 py-2 bg-green-600 text-white rounded-md hover:bg-green-700';
            }
        }

        function takePhoto() {
            openCamera();
        }

        function openWhatsAppModal(phone, studentName) {
            document.getElementById('phoneNumber').value = phone;
            document.getElementById('whatsappModal').classList.remove('hidden');
            updateMessage();
        }

        function closeWhatsAppModal() {
            document.getElementById('whatsappModal').classList.add('hidden');
        }

        function updateMessage() {
            const template = document.getElementById('messageTemplate').value;
            const messageContent = document.getElementById('messageContent');
            
            if (template !== 'custom') {
                messageContent.value = messageTemplates[template] || '';
            }
        }

        function sendWhatsApp(event) {
            event.preventDefault();
            const phone = document.getElementById('phoneNumber').value;
            const message = document.getElementById('messageContent').value;
            const template = document.getElementById('messageTemplate').value;
            
            // Find student by phone number
            const student = students.find(s => s.noOrtu === phone);
            const studentName = student ? student.nama : 'Siswa';
            
            // Format phone number
            const formattedPhone = phone.startsWith('08') ? '62' + phone.substring(1) : phone;
            const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
            
            // Add to history
            addWhatsAppHistory(phone, studentName, message, template);
            
            window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
            closeWhatsAppModal();
            showNotification('Pesan WhatsApp berhasil dikirim', 'success');
        }

        function sendBulkWA(category) {
            updateStudentStats();
            let targetStudents = [];
            
            switch(category) {
                case 'sangat':
                    targetStudents = students.filter(s => s.alpha >= 7);
                    break;
                case 'perhatian':
                    targetStudents = students.filter(s => s.alpha >= 4 && s.alpha < 7);
                    break;
                case 'pengawasan':
                    targetStudents = students.filter(s => s.alpha >= 2 && s.alpha < 4);
                    break;
            }
            
            if (targetStudents.length === 0) {
                showNotification('Tidak ada siswa dalam kategori ini', 'info');
                return;
            }
            
            if (confirm(`Kirim pesan WhatsApp ke ${targetStudents.length} orang tua?`)) {
                targetStudents.forEach(student => {
                    const formattedPhone = student.noOrtu.startsWith('08') ? '62' + student.noOrtu.substring(1) : student.noOrtu;
                    const template = category === 'sangat' ? 'sangat_bermasalah' : 
                                   category === 'perhatian' ? 'perlu_perhatian' : 'perlu_pengawasan';
                    const message = messageTemplates[template];
                    
                    // Add to history
                    addWhatsAppHistory(student.noOrtu, student.nama, message, template);
                    
                    const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                    setTimeout(() => {
                        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    }, 100); // Small delay to prevent browser blocking
                });
                showNotification(`Pesan berhasil dikirim ke ${targetStudents.length} orang tua`, 'success');
            }
        }

        function saveTemplate(type) {
            const templateId = `template${type.charAt(0).toUpperCase() + type.slice(1)}`;
            const newTemplate = document.getElementById(templateId).value;
            
            const templateKey = type === 'sangat' ? 'sangat_bermasalah' : 
                              type === 'perhatian' ? 'perlu_perhatian' : 'perlu_pengawasan';
            
            messageTemplates[templateKey] = newTemplate;
            showNotification('Template berhasil disimpan', 'success');
        }

        function exportToExcel(type) {
            let data = [];
            let filename = '';
            let headers = [];
            
            switch(type) {
                case 'kategori':
                    const bermasalahStudents = students.filter(s => s.alpha >= 2);
                    headers = ['Nama', 'NISN', 'Kelas', 'Alpha', 'Sakit', 'Izin', 'Kategori', 'No. Orang Tua'];
                    data = bermasalahStudents.map(s => {
                        let kategori = '';
                        if (s.alpha >= 7) kategori = 'Sangat Bermasalah';
                        else if (s.alpha >= 4) kategori = 'Perlu Perhatian';
                        else kategori = 'Perlu Pengawasan';
                        
                        return [s.nama, s.nisn, s.kelas, s.alpha, s.sakit, s.izin, kategori, s.noOrtu];
                    });
                    filename = `siswa_bermasalah_${Date.now()}.xlsx`;
                    break;
                    
                case 'siswa':
                    headers = ['Nama', 'NISN', 'Kelas', 'Alpha', 'Sakit', 'Izin', 'No. Orang Tua'];
                    data = students.map(s => [s.nama, s.nisn, s.kelas, s.alpha, s.sakit, s.izin, s.noOrtu]);
                    filename = `data_siswa_${Date.now()}.xlsx`;
                    break;
                    
                case 'admin-absensi':
                case 'laporan':
                    headers = ['Tanggal', 'Nama Siswa', 'NISN', 'Kelas', 'Mata Pelajaran', 'Guru', 'Status', 'Keterangan'];
                    data = attendanceData.map(record => {
                        const student = getStudentById(record.siswaId);
                        return [
                            new Date(record.tanggal).toLocaleDateString('id-ID'),
                            student?.nama || 'Tidak Ditemukan',
                            student?.nisn || '-',
                            student?.kelas || '-',
                            record.mapel,
                            record.guru,
                            record.status,
                            record.keterangan || '-'
                        ];
                    });
                    filename = `laporan_absensi_${Date.now()}.xlsx`;
                    break;
                    
                case 'guru':
                case 'admin-guru':
                    headers = ['Tanggal', 'Nama Guru', 'Mata Pelajaran', 'Kelas', 'Waktu', 'Lokasi', 'Materi'];
                    data = teacherAttendanceData.map(t => [
                        t.tanggal, t.nama, t.mapel, t.kelas, t.waktu, t.lokasi, t.materi
                    ]);
                    filename = `kehadiran_guru_${Date.now()}.xlsx`;
                    break;
                    
                case 'kelas':
                    const waliKelas = currentUser.kelas || 'X-A';
                    const classRecords = attendanceData.filter(record => {
                        const student = getStudentById(record.siswaId);
                        return student && student.kelas === waliKelas;
                    });
                    headers = ['Tanggal', 'Nama Siswa', 'NISN', 'Mata Pelajaran', 'Guru', 'Status', 'Keterangan'];
                    data = classRecords.map(record => {
                        const student = getStudentById(record.siswaId);
                        return [
                            new Date(record.tanggal).toLocaleDateString('id-ID'),
                            student?.nama || 'Tidak Ditemukan',
                            student?.nisn || '-',
                            record.mapel,
                            record.guru,
                            record.status,
                            record.keterangan || '-'
                        ];
                    });
                    filename = `absensi_kelas_${waliKelas}_${Date.now()}.xlsx`;
                    break;
                    
                case 'rekap-guru':
                    const teacherRecords = attendanceData.filter(record => record.guru === currentUser.name);
                    headers = ['Tanggal', 'Kelas', 'Mata Pelajaran', 'Nama Siswa', 'Status', 'Materi'];
                    data = teacherRecords.map(record => {
                        const student = getStudentById(record.siswaId);
                        return [
                            new Date(record.tanggal).toLocaleDateString('id-ID'),
                            student?.kelas || '-',
                            record.mapel,
                            student?.nama || 'Tidak Ditemukan',
                            record.status,
                            record.keterangan || '-'
                        ];
                    });
                    filename = `rekap_absensi_${currentUser.name.replace(/\s+/g, '_')}_${Date.now()}.xlsx`;
                    break;
                    
                default:
                    showNotification('Tipe export tidak dikenali', 'error');
                    return;
            }
            
            // Create Excel file and download
            createAndDownloadExcel(data, headers, filename);
        }

        function createAndDownloadExcel(data, headers, filename) {
            // Create Excel-compatible XML format
            let xmlContent = '<?xml version="1.0"?>\n';
            xmlContent += '<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet" xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet" xmlns:html="http://www.w3.org/TR/REC-html40">\n';
            xmlContent += '<DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">\n';
            xmlContent += '<Author>Sistem Absensi Siswa</Author>\n';
            xmlContent += '<Created>' + new Date().toISOString() + '</Created>\n';
            xmlContent += '</DocumentProperties>\n';
            xmlContent += '<Styles>\n';
            xmlContent += '<Style ss:ID="Header">\n';
            xmlContent += '<Font ss:Bold="1"/>\n';
            xmlContent += '<Interior ss:Color="#CCE5FF" ss:Pattern="Solid"/>\n';
            xmlContent += '</Style>\n';
            xmlContent += '<Style ss:ID="Title">\n';
            xmlContent += '<Font ss:Bold="1" ss:Size="14"/>\n';
            xmlContent += '<Alignment ss:Horizontal="Center"/>\n';
            xmlContent += '</Style>\n';
            xmlContent += '</Styles>\n';
            xmlContent += '<Worksheet ss:Name="Data Absensi">\n';
            xmlContent += '<Table>\n';
            
            // Add title row
            const currentDate = new Date().toLocaleDateString('id-ID');
            const currentTime = new Date().toLocaleTimeString('id-ID');
            xmlContent += '<Row>\n';
            xmlContent += `<Cell ss:MergeAcross="${headers.length - 1}" ss:StyleID="Title"><Data ss:Type="String">LAPORAN ABSENSI SISWA</Data></Cell>\n`;
            xmlContent += '</Row>\n';
            
            // Add metadata rows
            xmlContent += '<Row>\n';
            xmlContent += `<Cell ss:MergeAcross="${headers.length - 1}"><Data ss:Type="String">Tanggal Export: ${currentDate} ${currentTime}</Data></Cell>\n`;
            xmlContent += '</Row>\n';
            xmlContent += '<Row>\n';
            xmlContent += `<Cell ss:MergeAcross="${headers.length - 1}"><Data ss:Type="String">Total Data: ${data.length} record</Data></Cell>\n`;
            xmlContent += '</Row>\n';
            xmlContent += '<Row></Row>\n'; // Empty row
            
            // Add headers
            xmlContent += '<Row>\n';
            xmlContent += '<Cell ss:StyleID="Header"><Data ss:Type="String">No</Data></Cell>\n';
            headers.forEach(header => {
                xmlContent += `<Cell ss:StyleID="Header"><Data ss:Type="String">${header}</Data></Cell>\n`;
            });
            xmlContent += '</Row>\n';
            
            // Add data rows
            data.forEach((row, index) => {
                xmlContent += '<Row>\n';
                xmlContent += `<Cell><Data ss:Type="Number">${index + 1}</Data></Cell>\n`;
                row.forEach(cell => {
                    let cellStr = String(cell || '-');
                    let cellType = 'String';
                    
                    // Format specific data types
                    if (cellStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const date = new Date(cellStr);
                        cellStr = date.toLocaleDateString('id-ID');
                    } else if (!isNaN(cellStr) && cellStr !== '' && cellStr !== '-') {
                        cellType = 'Number';
                    }
                    
                    // Escape XML special characters
                    cellStr = cellStr.replace(/&/g, '&amp;')
                                   .replace(/</g, '&lt;')
                                   .replace(/>/g, '&gt;')
                                   .replace(/"/g, '&quot;')
                                   .replace(/'/g, '&apos;');
                    
                    xmlContent += `<Cell><Data ss:Type="${cellType}">${cellStr}</Data></Cell>\n`;
                });
                xmlContent += '</Row>\n';
            });
            
            // Add footer
            xmlContent += '<Row></Row>\n';
            xmlContent += '<Row>\n';
            xmlContent += `<Cell ss:MergeAcross="${headers.length - 1}"><Data ss:Type="String">Generated by Sistem Absensi Siswa</Data></Cell>\n`;
            xmlContent += '</Row>\n';
            xmlContent += '<Row>\n';
            xmlContent += `<Cell ss:MergeAcross="${headers.length - 1}"><Data ss:Type="String">¬© 2025 - Ian Dwi Putera, S.Pd</Data></Cell>\n`;
            xmlContent += '</Row>\n';
            
            xmlContent += '</Table>\n';
            xmlContent += '</Worksheet>\n';
            xmlContent += '</Workbook>\n';
            
            // Create blob with proper MIME type for Excel
            const blob = new Blob([xmlContent], { 
                type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
            });
            
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                // Ensure .xlsx extension
                const xlsxFilename = filename.replace(/\.(csv|xls)$/, '') + '.xlsx';
                link.setAttribute('download', xlsxFilename);
                link.style.visibility = 'hidden';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Clean up
                setTimeout(() => URL.revokeObjectURL(url), 100);
                
                showNotification(`‚úÖ File Excel berhasil didownload!\nüìä ${data.length} baris data\nüìÅ ${xlsxFilename}\nüí° Format: Microsoft Excel (.xlsx)`, 'success');
            } else {
                showNotification('Browser tidak mendukung download otomatis', 'error');
            }
        }

        function showKategoriDetail(kategori) {
            showNotification(`Menampilkan detail kategori ${kategori}`, 'info');
        }

        function viewStudentDetail(id) {
            showNotification('Menampilkan detail siswa', 'info');
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-200',
                error: 'bg-red-100 text-red-800 border-red-200',
                info: 'bg-blue-100 text-blue-800 border-blue-200'
            };
            
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-md border ${colors[type]} z-50 fade-in`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'} mr-2"></i>
                    ${message}
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Initialize time and location for teacher attendance
        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('id-ID');
            const timeInput = document.getElementById('currentTime');
            if (timeInput) {
                timeInput.value = timeString;
            }
        }

        function getCurrentLocation() {
            const locationInput = document.getElementById('currentLocation');
            const locationCoords = document.getElementById('locationCoords');
            const locationStatus = document.getElementById('locationStatus');
            const locationStatusText = document.getElementById('locationStatusText');
            
            if (locationInput) {
                if (navigator.geolocation) {
                    locationStatusText.textContent = 'Mengambil lokasi perangkat...';
                    
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const lat = position.coords.latitude.toFixed(6);
                            const lng = position.coords.longitude.toFixed(6);
                            locationInput.value = `${lat}, ${lng}`;
                            locationCoords.value = `${lat},${lng}`;
                            locationObtained = true;
                            
                            // Update status to success
                            locationStatus.className = 'mb-4 p-4 rounded-md bg-green-50 border border-green-200';
                            locationStatusText.innerHTML = '<i class="fas fa-check-circle text-green-600 mr-2"></i>Lokasi berhasil diperoleh';
                            
                            checkFormReadiness();
                            showNotification('Lokasi GPS berhasil diperoleh', 'success');
                        },
                        (error) => {
                            locationInput.value = 'Lokasi tidak tersedia';
                            locationObtained = false;
                            
                            // Update status to error
                            locationStatus.className = 'mb-4 p-4 rounded-md bg-red-50 border border-red-200';
                            locationStatusText.innerHTML = '<i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>Gagal mendapatkan lokasi. Aktifkan GPS dan refresh halaman.';
                            
                            showNotification('Gagal mendapatkan lokasi GPS. Pastikan GPS aktif dan izinkan akses lokasi.', 'error');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 60000
                        }
                    );
                } else {
                    locationInput.value = 'GPS tidak didukung';
                    locationObtained = false;
                    locationStatus.className = 'mb-4 p-4 rounded-md bg-red-50 border border-red-200';
                    locationStatusText.innerHTML = '<i class="fas fa-times-circle text-red-600 mr-2"></i>GPS tidak didukung oleh browser ini';
                }
            }
        }

        // Filter functions for each role
        function filterGuruAttendance() {
            const nama = document.getElementById('filterGuruNama').value.toLowerCase();
            const kelas = document.getElementById('filterGuruKelas').value;
            const tanggalMulai = document.getElementById('filterGuruTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterGuruTanggalAkhir').value;
            
            showNotification('Filter diterapkan pada data absensi guru', 'success');
        }

        function filterGuruAttendanceReal() {
            const nama = document.getElementById('filterGuruNama').value.toLowerCase();
            const kelas = document.getElementById('filterGuruKelas').value;
            const tanggalMulai = document.getElementById('filterGuruTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterGuruTanggalAkhir').value;
            
            const rows = document.querySelectorAll('#guruAttendanceTable tr[data-student-name]');
            
            rows.forEach(row => {
                const studentName = row.dataset.studentName || '';
                const studentClass = row.dataset.class || '';
                const rowDate = row.dataset.date || '';
                
                let show = true;
                
                // Filter by name
                if (nama && !studentName.includes(nama)) {
                    show = false;
                }
                
                // Filter by class
                if (kelas && studentClass !== kelas) {
                    show = false;
                }
                
                // Filter by date range
                if (tanggalMulai && rowDate < tanggalMulai) {
                    show = false;
                }
                if (tanggalAkhir && rowDate > tanggalAkhir) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        function resetGuruFilter() {
            document.getElementById('filterGuruNama').value = '';
            document.getElementById('filterGuruKelas').value = '';
            document.getElementById('filterGuruTanggalMulai').value = '';
            document.getElementById('filterGuruTanggalAkhir').value = '';
            
            const rows = document.querySelectorAll('#guruAttendanceTable tr[data-student-name]');
            rows.forEach(row => {
                row.style.display = '';
            });
            
            showNotification('Filter direset', 'info');
        }

        function editGuruAttendanceRecord(id) {
            const record = attendanceData.find(a => a.id === id);
            if (!record) {
                showNotification('Data absensi tidak ditemukan', 'error');
                return;
            }
            
            const student = getStudentById(record.siswaId);
            const newStatus = prompt(`Edit status absensi untuk ${student.nama}:\n\nPilihan: hadir, alpha, sakit, izin\nStatus saat ini: ${record.status}`, record.status);
            
            if (newStatus && ['hadir', 'alpha', 'sakit', 'izin'].includes(newStatus.toLowerCase())) {
                record.status = newStatus.toLowerCase();
                updateStudentStats();
                showNotification('Status absensi berhasil diubah', 'success');
                showContent('rekap-absensi');
            } else if (newStatus !== null) {
                showNotification('Status tidak valid. Gunakan: hadir, alpha, sakit, atau izin', 'error');
            }
        }

        function deleteGuruAttendanceRecord(id) {
            if (confirm('Yakin ingin menghapus data absensi ini?')) {
                const index = attendanceData.findIndex(a => a.id === id);
                if (index > -1) {
                    attendanceData.splice(index, 1);
                    updateStudentStats();
                    showNotification('Data absensi berhasil dihapus', 'success');
                    showContent('rekap-absensi');
                }
            }
        }

        function exportGuruAttendanceToExcel() {
            exportToExcel('rekap-guru');
        }

        function printGuruAttendance() {
            const teacherAttendanceRecords = attendanceData.filter(record => record.guru === currentUser.name);
            showNotification(`Print laporan ${teacherAttendanceRecords.length} data absensi guru berhasil (simulasi)`, 'success');
        }

        function exportWaliAttendanceToExcel() {
            const waliKelas = currentUser.kelas || 'X-A';
            const classAttendanceRecords = attendanceData.filter(record => {
                const student = getStudentById(record.siswaId);
                return student && student.kelas === waliKelas;
            });
            
            if (classAttendanceRecords.length === 0) {
                showNotification('Tidak ada data absensi untuk diekspor', 'error');
                return;
            }
            
            const headers = ['No', 'Tanggal', 'Nama Siswa', 'NISN', 'Mata Pelajaran', 'Guru', 'Status', 'Keterangan'];
            const data = classAttendanceRecords.map(record => {
                const student = getStudentById(record.siswaId);
                return [
                    new Date(record.tanggal).toLocaleDateString('id-ID'),
                    student?.nama || 'Tidak Ditemukan',
                    student?.nisn || '-',
                    record.mapel,
                    record.guru,
                    record.status.toUpperCase(),
                    record.keterangan || '-'
                ];
            });
            
            const filename = `absensi_kelas_${waliKelas}_${Date.now()}.csv`;
            createAndDownloadExcel(data, headers, filename);
        }

        function exportKepsekSiswaToExcel() {
            exportToExcel('siswa');
        }

        function printKepsekSiswaReport() {
            const visibleRows = document.querySelectorAll('#kepsekSiswaTable tr[data-name]:not([style*="display: none"])');
            showNotification(`Print laporan ${visibleRows.length} siswa berhasil (simulasi)`, 'success');
        }

        function filterWaliAttendance() {
            const nama = document.getElementById('filterWaliNama').value.toLowerCase();
            const mapel = document.getElementById('filterWaliMapel').value;
            const tanggalMulai = document.getElementById('filterWaliTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterWaliTanggalAkhir').value;
            
            showNotification('Filter diterapkan pada data absensi kelas', 'success');
        }

        function filterWaliAttendanceReal() {
            const nama = document.getElementById('filterWaliNama').value.toLowerCase();
            const mapel = document.getElementById('filterWaliMapel').value;
            const tanggalMulai = document.getElementById('filterWaliTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterWaliTanggalAkhir').value;
            
            const rows = document.querySelectorAll('#waliAttendanceTable tr[data-student-name]');
            
            rows.forEach(row => {
                const studentName = row.dataset.studentName || '';
                const subject = row.dataset.subject || '';
                const rowDate = row.dataset.date || '';
                
                let show = true;
                
                // Filter by name
                if (nama && !studentName.includes(nama)) {
                    show = false;
                }
                
                // Filter by subject
                if (mapel && subject !== mapel) {
                    show = false;
                }
                
                // Filter by date range
                if (tanggalMulai && rowDate < tanggalMulai) {
                    show = false;
                }
                if (tanggalAkhir && rowDate > tanggalAkhir) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        function resetWaliFilter() {
            document.getElementById('filterWaliNama').value = '';
            document.getElementById('filterWaliMapel').value = '';
            document.getElementById('filterWaliTanggalMulai').value = '';
            document.getElementById('filterWaliTanggalAkhir').value = '';
            
            const rows = document.querySelectorAll('#waliAttendanceTable tr[data-student-name]');
            rows.forEach(row => {
                row.style.display = '';
            });
            
            showNotification('Filter direset', 'info');
        }

        function showWaliKategoriDetail(kategori) {
            const waliKelas = currentUser.kelas || 'X-A';
            const classStudents = getStudentsByClass(waliKelas);
            let targetStudents = [];
            
            switch(kategori) {
                case 'sangat':
                    targetStudents = classStudents.filter(s => s.alpha >= 7);
                    break;
                case 'perhatian':
                    targetStudents = classStudents.filter(s => s.alpha >= 4 && s.alpha < 7);
                    break;
                case 'pengawasan':
                    targetStudents = classStudents.filter(s => s.alpha >= 2 && s.alpha < 4);
                    break;
                case 'baik':
                    targetStudents = classStudents.filter(s => s.alpha < 2);
                    break;
            }
            
            if (targetStudents.length === 0) {
                showNotification(`Tidak ada siswa dalam kategori ${kategori}`, 'info');
                return;
            }
            
            const studentNames = targetStudents.map(s => s.nama).join(', ');
            showNotification(`Siswa kategori ${kategori}: ${studentNames}`, 'info');
        }

        function viewWaliStudentDetail(id) {
            const student = getStudentById(id);
            if (!student) {
                showNotification('Data siswa tidak ditemukan', 'error');
                return;
            }
            
            const studentAttendance = getAttendanceByStudent(id);
            showNotification(`Detail ${student.nama}: ${studentAttendance.length} record absensi`, 'info');
        }

        function exportWaliAttendanceToExcel() {
            const waliKelas = currentUser.kelas || 'X-A';
            const classAttendanceRecords = attendanceData.filter(record => {
                const student = getStudentById(record.siswaId);
                return student && student.kelas === waliKelas;
            });
            
            showNotification(`Export ${classAttendanceRecords.length} data absensi kelas ${waliKelas} ke Excel berhasil (simulasi)`, 'success');
        }

        function sendBulkWAToClass() {
            const waliKelas = currentUser.kelas || 'X-A';
            const classStudents = getStudentsByClass(waliKelas);
            const bermasalahStudents = classStudents.filter(s => s.alpha >= 2);
            
            if (bermasalahStudents.length === 0) {
                showNotification('Tidak ada siswa bermasalah di kelas ini', 'info');
                return;
            }
            
            if (confirm(`Kirim pesan WhatsApp ke ${bermasalahStudents.length} orang tua siswa bermasalah di kelas ${waliKelas}?`)) {
                bermasalahStudents.forEach(student => {
                    const template = student.alpha >= 7 ? 'sangat_bermasalah' : 
                                   student.alpha >= 4 ? 'perlu_perhatian' : 'perlu_pengawasan';
                    const message = messageTemplates[template];
                    
                    // Add to history
                    addWhatsAppHistory(student.noOrtu, student.nama, message, template);
                    
                    const formattedPhone = student.noOrtu.startsWith('08') ? '62' + student.noOrtu.substring(1) : student.noOrtu;
                    const whatsappUrl = `https://wa.me/${formattedPhone}?text=${encodeURIComponent(message)}`;
                    
                    setTimeout(() => {
                        window.open(whatsappUrl, '_blank', 'noopener,noreferrer');
                    }, 100);
                });
                
                showNotification(`Pesan berhasil dikirim ke ${bermasalahStudents.length} orang tua`, 'success');
            }
        }

        function filterKepsekSiswa() {
            const nama = document.getElementById('filterKepsekNama').value.toLowerCase();
            const nisn = document.getElementById('filterKepsekNisn').value;
            const kelas = document.getElementById('filterKepsekKelas').value;
            const kategori = document.getElementById('filterKepsekKategori').value;
            const minAlpha = document.getElementById('filterKepsekMinAlpha').value;
            const maxAlpha = document.getElementById('filterKepsekMaxAlpha').value;
            
            showNotification('Filter diterapkan pada data siswa', 'success');
        }

        function filterKepsekSiswaReal() {
            const nama = document.getElementById('filterKepsekNama').value.toLowerCase();
            const nisn = document.getElementById('filterKepsekNisn').value;
            const kelas = document.getElementById('filterKepsekKelas').value;
            const kategori = document.getElementById('filterKepsekKategori').value;
            const minAlpha = parseInt(document.getElementById('filterKepsekMinAlpha').value) || 0;
            const maxAlpha = parseInt(document.getElementById('filterKepsekMaxAlpha').value) || 999;
            
            const rows = document.querySelectorAll('#kepsekSiswaTable tr[data-name]');
            
            rows.forEach(row => {
                const studentName = row.dataset.name || '';
                const studentNisn = row.dataset.nisn || '';
                const studentClass = row.dataset.class || '';
                const studentAlpha = parseInt(row.dataset.alpha) || 0;
                const studentCategory = row.dataset.category || '';
                
                let show = true;
                
                // Filter by name
                if (nama && !studentName.includes(nama)) {
                    show = false;
                }
                
                // Filter by NISN
                if (nisn && !studentNisn.includes(nisn)) {
                    show = false;
                }
                
                // Filter by class
                if (kelas && studentClass !== kelas) {
                    show = false;
                }
                
                // Filter by category
                if (kategori) {
                    const categoryMap = {
                        'sangat': 'sangat bermasalah',
                        'perhatian': 'perlu perhatian',
                        'pengawasan': 'perlu pengawasan',
                        'baik': 'baik'
                    };
                    if (studentCategory !== categoryMap[kategori]) {
                        show = false;
                    }
                }
                
                // Filter by alpha range
                if (studentAlpha < minAlpha || studentAlpha > maxAlpha) {
                    show = false;
                }
                
                row.style.display = show ? '' : 'none';
            });
        }

        function resetKepsekSiswaFilter() {
            document.getElementById('filterKepsekNama').value = '';
            document.getElementById('filterKepsekNisn').value = '';
            document.getElementById('filterKepsekKelas').value = '';
            document.getElementById('filterKepsekKategori').value = '';
            document.getElementById('filterKepsekMinAlpha').value = '';
            document.getElementById('filterKepsekMaxAlpha').value = '';
            
            const rows = document.querySelectorAll('#kepsekSiswaTable tr[data-name]');
            rows.forEach(row => {
                row.style.display = '';
            });
            
            showNotification('Filter direset', 'info');
        }

        function viewKepsekStudentDetail(id) {
            const student = getStudentById(id);
            if (!student) {
                showNotification('Data siswa tidak ditemukan', 'error');
                return;
            }
            
            const studentAttendance = getAttendanceByStudent(id);
            const attendanceBySubject = {};
            
            studentAttendance.forEach(record => {
                if (!attendanceBySubject[record.mapel]) {
                    attendanceBySubject[record.mapel] = { hadir: 0, alpha: 0, sakit: 0, izin: 0 };
                }
                attendanceBySubject[record.mapel][record.status]++;
            });
            
            let detailText = `Detail ${student.nama} (${student.kelas}):\n\n`;
            detailText += `Total Record: ${studentAttendance.length}\n`;
            detailText += `Alpha: ${student.alpha}, Sakit: ${student.sakit}, Izin: ${student.izin}\n\n`;
            detailText += `Per Mata Pelajaran:\n`;
            
            Object.entries(attendanceBySubject).forEach(([mapel, stats]) => {
                detailText += `${mapel}: H:${stats.hadir} A:${stats.alpha} S:${stats.sakit} I:${stats.izin}\n`;
            });
            
            showNotification(detailText, 'info');
        }

        function exportKepsekSiswaToExcel() {
            const visibleRows = document.querySelectorAll('#kepsekSiswaTable tr[data-name]:not([style*="display: none"])');
            showNotification(`Export ${visibleRows.length} data siswa ke Excel berhasil (simulasi)`, 'success');
        }

        function printKepsekSiswaReport() {
            const visibleRows = document.querySelectorAll('#kepsekSiswaTable tr[data-name]:not([style*="display: none"])');
            showNotification(`Print laporan ${visibleRows.length} siswa berhasil (simulasi)`, 'success');
        }

        function filterKepsekGuru() {
            const nama = document.getElementById('filterKepsekGuruNama').value.toLowerCase();
            const kelas = document.getElementById('filterKepsekGuruKelas').value;
            const tanggalMulai = document.getElementById('filterKepsekGuruTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterKepsekGuruTanggalAkhir').value;
            
            showNotification('Filter diterapkan pada data guru', 'success');
        }

        function resetKepsekGuruFilter() {
            document.getElementById('filterKepsekGuruNama').value = '';
            document.getElementById('filterKepsekGuruKelas').value = '';
            document.getElementById('filterKepsekGuruTanggalMulai').value = '';
            document.getElementById('filterKepsekGuruTanggalAkhir').value = '';
            showNotification('Filter direset', 'info');
        }

        function filterAdminAbsensi() {
            const nama = document.getElementById('filterAdminNama').value.toLowerCase();
            const nisn = document.getElementById('filterAdminNisn').value;
            const tanggalMulai = document.getElementById('filterAdminTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterAdminTanggalAkhir').value;
            
            showNotification('Filter diterapkan pada data absensi', 'success');
        }

        function resetAdminFilter() {
            document.getElementById('filterAdminNama').value = '';
            document.getElementById('filterAdminNisn').value = '';
            document.getElementById('filterAdminTanggalMulai').value = '';
            document.getElementById('filterAdminTanggalAkhir').value = '';
            showNotification('Filter direset', 'info');
        }

        function editAttendance(id) {
            showNotification('Membuka form edit absensi', 'info');
        }

        function editAttendanceRecord(id) {
            const record = attendanceData.find(a => a.id === id);
            if (!record) {
                showNotification('Data absensi tidak ditemukan', 'error');
                return;
            }
            
            const student = getStudentById(record.siswaId);
            const newStatus = prompt(`Edit status absensi untuk ${student.nama}:\n\nPilihan: hadir, alpha, sakit, izin\nStatus saat ini: ${record.status}`, record.status);
            
            if (newStatus && ['hadir', 'alpha', 'sakit', 'izin'].includes(newStatus.toLowerCase())) {
                record.status = newStatus.toLowerCase();
                updateStudentStats();
                showNotification('Status absensi berhasil diubah', 'success');
                showContent(currentMenu);
            } else if (newStatus !== null) {
                showNotification('Status tidak valid. Gunakan: hadir, alpha, sakit, atau izin', 'error');
            }
        }

        function deleteAttendanceRecord(id) {
            if (confirm('Yakin ingin menghapus data absensi ini?')) {
                const index = attendanceData.findIndex(a => a.id === id);
                if (index > -1) {
                    attendanceData.splice(index, 1);
                    updateStudentStats();
                    showNotification('Data absensi berhasil dihapus', 'success');
                    showContent(currentMenu);
                }
            }
        }

        function deleteAllAttendance() {
            if (confirm('PERINGATAN: Yakin ingin menghapus SEMUA data absensi? Tindakan ini tidak dapat dibatalkan!')) {
                if (confirm('Konfirmasi sekali lagi: Hapus SEMUA data absensi?')) {
                    attendanceData.length = 0;
                    updateStudentStats();
                    showNotification('Semua data absensi berhasil dihapus', 'success');
                    showContent(currentMenu);
                }
            }
        }

        function viewDailyDetail(id) {
            showNotification('Menampilkan detail absensi harian', 'info');
        }

        // Student attendance search functions
        function searchStudentAttendance(event) {
            event.preventDefault();
            const nisn = document.getElementById('searchNisn').value.trim();
            
            if (!nisn) {
                showNotification('Masukkan NISN terlebih dahulu', 'error');
                return;
            }
            
            // Cari siswa berdasarkan NISN
            const student = students.find(s => s.nisn === nisn);
            
            if (!student) {
                showNotification('NISN tidak ditemukan dalam database', 'error');
                return;
            }
            
            // Tampilkan modal dengan data kehadiran
            showAttendanceSearchResult(student);
        }

        function showAttendanceSearchResult(student) {
            const modal = document.getElementById('attendanceSearchModal');
            const resultDiv = document.getElementById('attendanceSearchResult');
            
            // Generate data absensi detail untuk siswa
            const attendanceHistory = generateStudentAttendanceHistory(student);
            
            resultDiv.innerHTML = `
                <div class="mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <h4 class="text-lg font-semibold text-blue-900 mb-2">Informasi Siswa</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                            <div>
                                <p><strong>Nama:</strong> ${student.nama}</p>
                                <p><strong>NISN:</strong> ${student.nisn}</p>
                            </div>
                            <div>
                                <p><strong>Kelas:</strong> ${student.kelas}</p>
                                <p><strong>No. Orang Tua:</strong> ${student.noOrtu}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200 text-center">
                        <div class="text-2xl font-bold text-green-600">${30 - student.alpha - student.sakit - student.izin}</div>
                        <div class="text-sm text-green-700">Hadir</div>
                    </div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200 text-center">
                        <div class="text-2xl font-bold text-red-600">${student.alpha}</div>
                        <div class="text-sm text-red-700">Alpha</div>
                    </div>
                    <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200 text-center">
                        <div class="text-2xl font-bold text-yellow-600">${student.sakit}</div>
                        <div class="text-sm text-yellow-700">Sakit</div>
                    </div>
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 text-center">
                        <div class="text-2xl font-bold text-blue-600">${student.izin}</div>
                        <div class="text-sm text-blue-700">Izin</div>
                    </div>
                </div>

                <div class="mb-4">
                    <h4 class="text-lg font-semibold text-gray-900 mb-3">Riwayat Kehadiran (30 Hari Terakhir)</h4>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 border border-gray-200 rounded-lg">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Guru</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Keterangan</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${attendanceHistory.map(record => `
                                    <tr>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${record.tanggal}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-900">${record.guru}</td>
                                        <td class="px-4 py-3 whitespace-nowrap">
                                            <span class="px-2 py-1 text-xs font-medium rounded-full ${getStatusBadge(record.status)}">${record.status}</span>
                                        </td>
                                        <td class="px-4 py-3 whitespace-nowrap text-sm text-gray-500">${record.keterangan}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-yellow-50 p-4 rounded-lg border border-yellow-200">
                    <div class="flex items-start">
                        <i class="fas fa-info-circle text-yellow-600 mt-1 mr-3"></i>
                        <div class="text-sm text-yellow-800">
                            <p class="font-medium mb-1">Informasi Penting:</p>
                            <ul class="list-disc list-inside space-y-1">
                                <li>Data kehadiran diperbarui secara real-time oleh guru mata pelajaran</li>
                                <li>Jika ada ketidaksesuaian data, silakan hubungi wali kelas</li>
                                <li>Persentase kehadiran: <strong>${(((30 - student.alpha - student.sakit - student.izin) / 30) * 100).toFixed(1)}%</strong></li>
                            </ul>
                        </div>
                    </div>
                </div>
            `;
            
            modal.classList.remove('hidden');
        }

        function generateStudentAttendanceHistory(student) {
            // Generate sample attendance history
            const subjects = ['Matematika', 'Bahasa Indonesia', 'Fisika', 'Kimia', 'Biologi', 'Sejarah'];
            const teachers = ['Pak Budi', 'Bu Siti', 'Pak Ahmad', 'Bu Dewi', 'Pak Eko', 'Bu Rina'];
            const statuses = ['hadir', 'alpha', 'sakit', 'izin'];
            const keteranganMap = {
                hadir: 'Hadir tepat waktu',
                alpha: 'Tidak hadir tanpa keterangan',
                sakit: 'Sakit dengan surat dokter',
                izin: 'Izin keperluan keluarga'
            };
            
            const history = [];
            const today = new Date();
            
            for (let i = 0; i < 15; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                // Skip weekends
                if (date.getDay() === 0 || date.getDay() === 6) continue;
                
                const randomSubject = subjects[Math.floor(Math.random() * subjects.length)];
                const randomTeacher = teachers[Math.floor(Math.random() * teachers.length)];
                
                // Bias towards 'hadir' status
                let status;
                const rand = Math.random();
                if (rand < 0.8) status = 'hadir';
                else if (rand < 0.9) status = 'izin';
                else if (rand < 0.95) status = 'sakit';
                else status = 'alpha';
                
                history.push({
                    tanggal: date.toLocaleDateString('id-ID'),
                    mapel: randomSubject,
                    guru: randomTeacher,
                    status: status,
                    keterangan: keteranganMap[status]
                });
            }
            
            return history.sort((a, b) => new Date(b.tanggal) - new Date(a.tanggal));
        }

        function closeAttendanceSearchModal() {
            document.getElementById('attendanceSearchModal').classList.add('hidden');
            document.getElementById('searchNisn').value = '';
        }

        // Admin Teacher Management Functions
        function filterAdminGuru() {
            const nama = document.getElementById('filterAdminGuruNama').value.toLowerCase();
            const kelas = document.getElementById('filterAdminGuruKelas').value;
            const tanggalMulai = document.getElementById('filterAdminGuruTanggalMulai').value;
            const tanggalAkhir = document.getElementById('filterAdminGuruTanggalAkhir').value;
            
            showNotification('Filter diterapkan pada data guru', 'success');
        }

        function resetAdminGuruFilter() {
            document.getElementById('filterAdminGuruNama').value = '';
            document.getElementById('filterAdminGuruKelas').value = '';
            document.getElementById('filterAdminGuruTanggalMulai').value = '';
            document.getElementById('filterAdminGuruTanggalAkhir').value = '';
            showNotification('Filter direset', 'info');
        }

        function addTeacherAttendance() {
            const newData = {
                id: Date.now(),
                nama: 'Guru Baru',
                kelas: 'X-A',
                waktu: '08:00',
                lokasi: '-6.2088, 106.8456',
                mapel: 'Mata Pelajaran',
                tanggal: new Date().toLocaleDateString('id-ID'),
                materi: 'Materi Pembelajaran'
            };
            
            showNotification('Data kehadiran guru baru berhasil ditambahkan', 'success');
            showContent('ringkasan-guru');
        }

        function editTeacherAttendance(id) {
            showNotification(`Membuka form edit untuk data guru ID: ${id}`, 'info');
        }

        function deleteTeacherAttendance(id) {
            if (confirm('Yakin ingin menghapus data kehadiran guru ini?')) {
                showNotification('Data kehadiran guru berhasil dihapus', 'success');
                showContent('ringkasan-guru');
            }
        }

        function deleteAllTeacherAttendance() {
            if (confirm('PERINGATAN: Yakin ingin menghapus SEMUA data kehadiran guru? Tindakan ini tidak dapat dibatalkan!')) {
                if (confirm('Konfirmasi sekali lagi: Hapus SEMUA data kehadiran guru?')) {
                    showNotification('Semua data kehadiran guru berhasil dihapus', 'success');
                    showContent('ringkasan-guru');
                }
            }
        }

        function toggleAllTeachers() {
            const selectAll = document.getElementById('selectAllTeachers');
            const checkboxes = document.querySelectorAll('.teacher-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSelectedButtons();
        }

        function updateSelectedButtons() {
            const checkboxes = document.querySelectorAll('.teacher-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedBtn');
            const editBtn = document.getElementById('editSelectedBtn');
            
            if (deleteBtn && editBtn) {
                const hasSelected = checkboxes.length > 0;
                deleteBtn.disabled = !hasSelected;
                editBtn.disabled = !hasSelected;
            }
        }

        function deleteSelectedTeachers() {
            const checkboxes = document.querySelectorAll('.teacher-checkbox:checked');
            const selectedCount = checkboxes.length;
            
            if (selectedCount === 0) {
                showNotification('Pilih data yang ingin dihapus terlebih dahulu', 'error');
                return;
            }
            
            if (confirm(`Yakin ingin menghapus ${selectedCount} data kehadiran guru yang dipilih?`)) {
                showNotification(`${selectedCount} data kehadiran guru berhasil dihapus`, 'success');
                showContent('ringkasan-guru');
            }
        }

        function editSelectedTeachers() {
            const checkboxes = document.querySelectorAll('.teacher-checkbox:checked');
            const selectedCount = checkboxes.length;
            
            if (selectedCount === 0) {
                showNotification('Pilih data yang ingin diedit terlebih dahulu', 'error');
                return;
            }
            
            showNotification(`Membuka form edit batch untuk ${selectedCount} data guru`, 'info');
        }

        // Event listener for checkbox changes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('teacher-checkbox')) {
                updateSelectedButtons();
            }
        });

        function renderRiwayatKehadiranGuru() {
            const myAttendanceRecords = teacherAttendanceData.filter(record => record.nama === currentUser.name);
            
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Riwayat Kehadiran Saya</h2>
                    <p class="text-gray-600">Data kehadiran dengan lokasi GPS dan foto verifikasi (${myAttendanceRecords.length} record)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-calendar-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Kehadiran</p>
                                <p class="text-2xl font-bold text-gray-900">${myAttendanceRecords.length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-chalkboard-teacher text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Kelas Diajar</p>
                                <p class="text-2xl font-bold text-gray-900">${new Set(myAttendanceRecords.map(r => r.kelas)).size}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-book text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Mata Pelajaran</p>
                                <p class="text-2xl font-bold text-gray-900">${new Set(myAttendanceRecords.map(r => r.mapel)).size}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Detail Riwayat Kehadiran</h3>
                        <button onclick="exportMyTeacherAttendance()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi GPS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                ${myAttendanceRecords.length === 0 ? 
                                    '<tr><td colspan="7" class="px-6 py-4 text-center text-gray-500">Belum ada riwayat kehadiran</td></tr>' :
                                    myAttendanceRecords.slice().reverse().map(record => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.tanggal}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.waktu}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.kelas}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.materi}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${record.lokasi.includes(',') ? 
                                            `<a href="https://www.google.com/maps?q=${record.lokasi}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">${record.lokasi}</a>` : 
                                            record.lokasi
                                        }
                                    </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                                    <i class="fas fa-check mr-1"></i>Hadir
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderKehadiranGuruAdmin() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Kehadiran Guru (Admin)</h2>
                    <p class="text-gray-600">Monitoring kehadiran guru dengan lokasi GPS dan foto verifikasi</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-user-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Kehadiran</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Guru Aktif</p>
                                <p class="text-2xl font-bold text-gray-900">${new Set(teacherAttendanceData.map(r => r.nama)).size}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-calendar-day text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hari Ini</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.filter(r => r.tanggal === new Date().toLocaleDateString('id-ID')).length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                                <i class="fas fa-map-marker-alt text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Dengan GPS</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.filter(r => r.lokasi && r.lokasi !== 'Sekolah').length}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Kehadiran Guru</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="filterAdminTeacherNama" type="text" placeholder="Nama Guru" class="px-3 py-2 border border-gray-300 rounded-md">
                        <select id="filterAdminTeacherKelas" class="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Semua Kelas</option>
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-A">XI-A</option>
                            <option value="XI-B">XI-B</option>
                            <option value="XII-A">XII-A</option>
                            <option value="XII-B">XII-B</option>
                        </select>
                        <input id="filterAdminTeacherTanggal" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                        <button onclick="filterAdminTeacherAttendance()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetAdminTeacherFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="exportAllTeacherAttendance()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 ml-2">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="deleteAllTeacherAttendanceAdmin()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 ml-2">
                            <i class="fas fa-trash mr-2"></i>Hapus Semua
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Kehadiran Guru Real-Time</h3>
                        <div class="text-sm text-gray-600">
                            Total: ${teacherAttendanceData.length} record kehadiran
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                        <input type="checkbox" id="selectAllAdminTeachers" onchange="toggleAllAdminTeachers()" class="mr-2">
                                        Pilih
                                    </th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi GPS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verifikasi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="adminTeacherAttendanceTable" class="bg-white divide-y divide-gray-200">
                                ${teacherAttendanceData.length === 0 ? 
                                    '<tr><td colspan="10" class="px-6 py-4 text-center text-gray-500">Belum ada data kehadiran guru</td></tr>' :
                                    teacherAttendanceData.slice().reverse().map((record, index) => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <input type="checkbox" class="admin-teacher-checkbox" value="${record.id}">
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.tanggal}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.waktu}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.nama}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.kelas}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.materi}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${record.lokasi.includes(',') ? 
                                            `<a href="https://www.google.com/maps?q=${record.lokasi}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">${record.lokasi}</a>` : 
                                            record.lokasi
                                        }
                                    </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center space-x-2">
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                                        <i class="fas fa-map-marker-alt mr-1"></i>GPS
                                                    </span>
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                                        <i class="fas fa-camera mr-1"></i>Foto
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                                                <button onclick="viewTeacherAttendanceDetail(${record.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button onclick="editAdminTeacherAttendance(${record.id})" class="text-green-600 hover:text-green-900 mr-3">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button onclick="deleteAdminTeacherAttendance(${record.id})" class="text-red-600 hover:text-red-900">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex items-center space-x-2">
                            <button onclick="deleteSelectedAdminTeachers()" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:bg-gray-400" id="deleteSelectedAdminTeachersBtn" disabled>
                                <i class="fas fa-trash mr-2"></i>Hapus Terpilih
                            </button>
                            <button onclick="exportSelectedAdminTeachers()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 disabled:bg-gray-400" id="exportSelectedAdminTeachersBtn" disabled>
                                <i class="fas fa-file-excel mr-2"></i>Export Terpilih
                            </button>
                        </div>
                        <div class="text-sm text-gray-600">
                            Menampilkan ${teacherAttendanceData.length} dari ${teacherAttendanceData.length} data
                        </div>
                    </div>
                </div>
            `;
        }

        // Initialize sample data for testing
        function initializeSampleData() {
            // Update student stats based on sample attendance data
            updateStudentStats();
            
            // Add some sample WhatsApp history
            addWhatsAppHistory('081234567890', 'Ahmad Rizki', messageTemplates.sangat_bermasalah, 'sangat_bermasalah');
            addWhatsAppHistory('081234567891', 'Siti Aminah', messageTemplates.perlu_perhatian, 'perlu_perhatian');
        }

        // Update time every second
        setInterval(updateCurrentTime, 1000);

        // Initialize location when teacher attendance page is shown
        function initializeTeacherAttendance() {
            setTimeout(() => {
                getCurrentLocation();
                updateCurrentTime();
            }, 500);
        }

        // New functions for teacher attendance management
        function exportMyTeacherAttendance() {
            const myAttendanceRecords = teacherAttendanceData.filter(record => record.nama === currentUser.name);
            
            if (myAttendanceRecords.length === 0) {
                showNotification('Tidak ada data kehadiran untuk diekspor', 'error');
                return;
            }
            
            const headers = ['No', 'Tanggal', 'Waktu', 'Kelas', 'Mata Pelajaran', 'Materi', 'Lokasi GPS'];
            const data = myAttendanceRecords.map(record => [
                record.tanggal,
                record.waktu,
                record.kelas,
                record.mapel,
                record.materi,
                record.lokasi
            ]);
            
            const filename = `riwayat_kehadiran_${currentUser.name.replace(/\s+/g, '_')}_${Date.now()}.csv`;
            createAndDownloadExcel(data, headers, filename);
        }

        function exportAllTeacherAttendance() {
            if (teacherAttendanceData.length === 0) {
                showNotification('Tidak ada data kehadiran guru untuk diekspor', 'error');
                return;
            }
            
            const headers = ['No', 'Tanggal', 'Waktu', 'Nama Guru', 'Kelas', 'Mata Pelajaran', 'Materi', 'Lokasi GPS'];
            const data = teacherAttendanceData.map(record => [
                record.tanggal,
                record.waktu,
                record.nama,
                record.kelas,
                record.mapel,
                record.materi,
                record.lokasi
            ]);
            
            const filename = `kehadiran_semua_guru_${Date.now()}.csv`;
            createAndDownloadExcel(data, headers, filename);
        }

        function filterAdminTeacherAttendance() {
            const nama = document.getElementById('filterAdminTeacherNama').value.toLowerCase();
            const kelas = document.getElementById('filterAdminTeacherKelas').value;
            const tanggal = document.getElementById('filterAdminTeacherTanggal').value;
            
            showNotification('Filter diterapkan pada data kehadiran guru', 'success');
        }

        function resetAdminTeacherFilter() {
            document.getElementById('filterAdminTeacherNama').value = '';
            document.getElementById('filterAdminTeacherKelas').value = '';
            document.getElementById('filterAdminTeacherTanggal').value = '';
            showNotification('Filter direset', 'info');
        }

        function deleteAllTeacherAttendanceAdmin() {
            if (confirm('PERINGATAN: Yakin ingin menghapus SEMUA data kehadiran guru? Tindakan ini tidak dapat dibatalkan!')) {
                if (confirm('Konfirmasi sekali lagi: Hapus SEMUA data kehadiran guru?')) {
                    teacherAttendanceData.length = 0;
                    showNotification('Semua data kehadiran guru berhasil dihapus', 'success');
                    showContent('kehadiran-guru-admin');
                }
            }
        }

        function toggleAllAdminTeachers() {
            const selectAll = document.getElementById('selectAllAdminTeachers');
            const checkboxes = document.querySelectorAll('.admin-teacher-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
            
            updateSelectedAdminTeachersButtons();
        }

        function updateSelectedAdminTeachersButtons() {
            const checkboxes = document.querySelectorAll('.admin-teacher-checkbox:checked');
            const deleteBtn = document.getElementById('deleteSelectedAdminTeachersBtn');
            const exportBtn = document.getElementById('exportSelectedAdminTeachersBtn');
            
            if (deleteBtn && exportBtn) {
                const hasSelected = checkboxes.length > 0;
                deleteBtn.disabled = !hasSelected;
                exportBtn.disabled = !hasSelected;
            }
        }

        function deleteSelectedAdminTeachers() {
            const checkboxes = document.querySelectorAll('.admin-teacher-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showNotification('Pilih data yang ingin dihapus terlebih dahulu', 'error');
                return;
            }
            
            if (confirm(`Yakin ingin menghapus ${selectedIds.length} data kehadiran guru yang dipilih?`)) {
                // Remove selected records
                for (let i = teacherAttendanceData.length - 1; i >= 0; i--) {
                    if (selectedIds.includes(teacherAttendanceData[i].id)) {
                        teacherAttendanceData.splice(i, 1);
                    }
                }
                
                showNotification(`${selectedIds.length} data kehadiran guru berhasil dihapus`, 'success');
                showContent('kehadiran-guru-admin');
            }
        }

        function exportSelectedAdminTeachers() {
            const checkboxes = document.querySelectorAll('.admin-teacher-checkbox:checked');
            const selectedIds = Array.from(checkboxes).map(cb => parseInt(cb.value));
            
            if (selectedIds.length === 0) {
                showNotification('Pilih data yang ingin diekspor terlebih dahulu', 'error');
                return;
            }
            
            const selectedRecords = teacherAttendanceData.filter(record => selectedIds.includes(record.id));
            
            const headers = ['No', 'Tanggal', 'Waktu', 'Nama Guru', 'Kelas', 'Mata Pelajaran', 'Materi', 'Lokasi GPS'];
            const data = selectedRecords.map(record => [
                record.tanggal,
                record.waktu,
                record.nama,
                record.kelas,
                record.mapel,
                record.materi,
                record.lokasi
            ]);
            
            const filename = `kehadiran_guru_terpilih_${Date.now()}.csv`;
            createAndDownloadExcel(data, headers, filename);
        }

        function viewTeacherAttendanceDetail(id) {
            const record = teacherAttendanceData.find(r => r.id === id);
            if (!record) {
                showNotification('Data kehadiran tidak ditemukan', 'error');
                return;
            }
            
            showNotification(`Detail kehadiran ${record.nama}:\nüìÖ ${record.tanggal} ${record.waktu}\nüè´ ${record.kelas} - ${record.mapel}\nüìç ${record.lokasi}\nüìö ${record.materi}`, 'info');
        }

        function editAdminTeacherAttendance(id) {
            const record = teacherAttendanceData.find(r => r.id === id);
            if (!record) {
                showNotification('Data kehadiran tidak ditemukan', 'error');
                return;
            }
            
            // Show edit modal
            showEditTeacherLocationModal(record);
        }

        function showEditTeacherLocationModal(record) {
            const modal = document.createElement('div');
            modal.id = 'editLocationModal';
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-full max-w-md mx-4">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold">Edit Data Kehadiran Guru</h3>
                        <button onclick="closeEditLocationModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nama Guru</label>
                            <input type="text" value="${record.nama}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Materi Pembelajaran</label>
                            <textarea id="editMateri" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-blue-500 focus:border-blue-500">${record.materi}</textarea>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Lokasi GPS</label>
                            <input type="text" id="editLokasi" value="${record.lokasi}" readonly class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50">
                            <div class="mt-2 flex space-x-2">
                                <button onclick="updateLocationToCurrentDevice()" class="px-3 py-1 bg-blue-600 text-white rounded text-sm hover:bg-blue-700">
                                    <i class="fas fa-map-marker-alt mr-1"></i>Update ke Lokasi Perangkat Saya
                                </button>
                                <button onclick="viewLocationOnMap('${record.lokasi}')" class="px-3 py-1 bg-green-600 text-white rounded text-sm hover:bg-green-700">
                                    <i class="fas fa-map mr-1"></i>Lihat di Maps
                                </button>
                            </div>
                        </div>
                        <div id="locationUpdateStatus" class="hidden p-3 rounded-md">
                            <div class="flex items-center">
                                <i class="fas fa-spinner fa-spin mr-2"></i>
                                <span>Mengambil lokasi perangkat...</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeEditLocationModal()" class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50">
                            Batal
                        </button>
                        <button onclick="saveEditedTeacherAttendance(${record.id})" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-save mr-2"></i>Simpan
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        function closeEditLocationModal() {
            const modal = document.getElementById('editLocationModal');
            if (modal) {
                modal.remove();
            }
        }

        function updateLocationToCurrentDevice() {
            const statusDiv = document.getElementById('locationUpdateStatus');
            const lokasiInput = document.getElementById('editLokasi');
            
            statusDiv.classList.remove('hidden');
            statusDiv.className = 'p-3 rounded-md bg-blue-50 border border-blue-200';
            statusDiv.innerHTML = `
                <div class="flex items-center">
                    <i class="fas fa-spinner fa-spin text-blue-600 mr-2"></i>
                    <span class="text-blue-800">Mengambil lokasi perangkat...</span>
                </div>
            `;
            
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const lat = position.coords.latitude.toFixed(6);
                        const lng = position.coords.longitude.toFixed(6);
                        const newLocation = `${lat}, ${lng}`;
                        
                        lokasiInput.value = newLocation;
                        
                        statusDiv.className = 'p-3 rounded-md bg-green-50 border border-green-200';
                        statusDiv.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-check-circle text-green-600 mr-2"></i>
                                <span class="text-green-800">Lokasi berhasil diperbarui ke: ${newLocation}</span>
                            </div>
                        `;
                        
                        setTimeout(() => {
                            statusDiv.classList.add('hidden');
                        }, 3000);
                    },
                    (error) => {
                        statusDiv.className = 'p-3 rounded-md bg-red-50 border border-red-200';
                        statusDiv.innerHTML = `
                            <div class="flex items-center">
                                <i class="fas fa-exclamation-triangle text-red-600 mr-2"></i>
                                <span class="text-red-800">Gagal mendapatkan lokasi. Pastikan GPS aktif dan izinkan akses lokasi.</span>
                            </div>
                        `;
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            } else {
                statusDiv.className = 'p-3 rounded-md bg-red-50 border border-red-200';
                statusDiv.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-times-circle text-red-600 mr-2"></i>
                        <span class="text-red-800">GPS tidak didukung oleh browser ini</span>
                    </div>
                `;
            }
        }

        function viewLocationOnMap(location) {
            if (location && location.includes(',')) {
                const mapsUrl = `https://www.google.com/maps?q=${location}`;
                window.open(mapsUrl, '_blank', 'noopener,noreferrer');
            } else {
                showNotification('Koordinat lokasi tidak valid', 'error');
            }
        }

        function saveEditedTeacherAttendance(id) {
            const record = teacherAttendanceData.find(r => r.id === id);
            if (!record) {
                showNotification('Data kehadiran tidak ditemukan', 'error');
                return;
            }
            
            const newMateri = document.getElementById('editMateri').value.trim();
            const newLokasi = document.getElementById('editLokasi').value.trim();
            
            if (!newMateri) {
                showNotification('Materi pembelajaran harus diisi', 'error');
                return;
            }
            
            if (!newLokasi) {
                showNotification('Lokasi GPS harus diisi', 'error');
                return;
            }
            
            // Update record
            record.materi = newMateri;
            record.lokasi = newLokasi;
            
            closeEditLocationModal();
            showNotification('Data kehadiran guru berhasil diupdate', 'success');
            showContent('kehadiran-guru-admin');
        }

        function deleteAdminTeacherAttendance(id) {
            if (confirm('Yakin ingin menghapus data kehadiran guru ini?')) {
                const index = teacherAttendanceData.findIndex(r => r.id === id);
                if (index > -1) {
                    teacherAttendanceData.splice(index, 1);
                    showNotification('Data kehadiran guru berhasil dihapus', 'success');
                    showContent('kehadiran-guru-admin');
                }
            }
        }

        // Event listener for admin teacher checkbox changes
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('admin-teacher-checkbox')) {
                updateSelectedAdminTeachersButtons();
            }
        });

        function renderRiwayatGuruKepsek() {
            return `
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Riwayat Kehadiran Guru</h2>
                    <p class="text-gray-600">Monitoring kehadiran guru dengan lokasi GPS dan foto verifikasi (${teacherAttendanceData.length} record)</p>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-green-100 text-green-600">
                                <i class="fas fa-user-check text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Total Kehadiran</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-blue-100 text-blue-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Guru Aktif</p>
                                <p class="text-2xl font-bold text-gray-900">${new Set(teacherAttendanceData.map(r => r.nama)).size}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-purple-100 text-purple-600">
                                <i class="fas fa-calendar-day text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Hari Ini</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.filter(r => r.tanggal === new Date().toLocaleDateString('id-ID')).length}</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-sm border">
                        <div class="flex items-center">
                            <div class="p-3 rounded-full bg-orange-100 text-orange-600">
                                <i class="fas fa-map-marker-alt text-xl"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-600">Dengan GPS</p>
                                <p class="text-2xl font-bold text-gray-900">${teacherAttendanceData.filter(r => r.lokasi && r.lokasi !== 'Sekolah').length}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Filter Data Kehadiran Guru</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <input id="filterKepsekRiwayatNama" type="text" placeholder="Nama Guru" class="px-3 py-2 border border-gray-300 rounded-md">
                        <select id="filterKepsekRiwayatKelas" class="px-3 py-2 border border-gray-300 rounded-md">
                            <option value="">Semua Kelas</option>
                            <option value="X-A">X-A</option>
                            <option value="X-B">X-B</option>
                            <option value="XI-A">XI-A</option>
                            <option value="XI-B">XI-B</option>
                            <option value="XII-A">XII-A</option>
                            <option value="XII-B">XII-B</option>
                        </select>
                        <input id="filterKepsekRiwayatTanggal" type="date" class="px-3 py-2 border border-gray-300 rounded-md">
                        <button onclick="filterKepsekRiwayatGuru()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700">
                            <i class="fas fa-search mr-2"></i>Filter
                        </button>
                    </div>
                    <div class="mt-4">
                        <button onclick="resetKepsekRiwayatFilter()" class="px-4 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700">
                            <i class="fas fa-undo mr-2"></i>Reset
                        </button>
                        <button onclick="exportKepsekRiwayatGuru()" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 ml-2">
                            <i class="fas fa-file-excel mr-2"></i>Export Excel
                        </button>
                        <button onclick="printKepsekRiwayatGuru()" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 ml-2">
                            <i class="fas fa-print mr-2"></i>Print Laporan
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-sm border p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Data Kehadiran Guru Detail</h3>
                        <div class="text-sm text-gray-600">
                            Total: ${teacherAttendanceData.length} record kehadiran
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Waktu</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama Guru</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kelas</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mata Pelajaran</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Materi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi GPS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Verifikasi</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                </tr>
                            </thead>
                            <tbody id="kepsekRiwayatGuruTable" class="bg-white divide-y divide-gray-200">
                                ${teacherAttendanceData.length === 0 ? 
                                    '<tr><td colspan="9" class="px-6 py-4 text-center text-gray-500">Belum ada data kehadiran guru</td></tr>' :
                                    teacherAttendanceData.slice().reverse().map(record => `
                                        <tr>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.tanggal}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.waktu}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${record.nama}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.kelas}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.mapel}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${record.materi}</td>
                                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                        ${record.lokasi.includes(',') ? 
                                            `<a href="https://www.google.com/maps?q=${record.lokasi}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800 underline">${record.lokasi}</a>` : 
                                            record.lokasi
                                        }
                                    </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <div class="flex items-center space-x-2">
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                                        <i class="fas fa-map-marker-alt mr-1"></i>GPS
                                                    </span>
                                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800">
                                                        <i class="fas fa-camera mr-1"></i>Foto
                                                    </span>
                                                </div>
                                            </td>
                                            <td class="px-6 py-4 whitespace-nowrap">
                                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800">
                                                    <i class="fas fa-check mr-1"></i>Hadir
                                                </span>
                                            </td>
                                        </tr>
                                    `).join('')
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function filterKepsekRiwayatGuru() {
            const nama = document.getElementById('filterKepsekRiwayatNama').value.toLowerCase();
            const kelas = document.getElementById('filterKepsekRiwayatKelas').value;
            const tanggal = document.getElementById('filterKepsekRiwayatTanggal').value;
            
            showNotification('Filter diterapkan pada riwayat kehadiran guru', 'success');
        }

        function resetKepsekRiwayatFilter() {
            document.getElementById('filterKepsekRiwayatNama').value = '';
            document.getElementById('filterKepsekRiwayatKelas').value = '';
            document.getElementById('filterKepsekRiwayatTanggal').value = '';
            showNotification('Filter direset', 'info');
        }

        function exportKepsekRiwayatGuru() {
            if (teacherAttendanceData.length === 0) {
                showNotification('Tidak ada data kehadiran guru untuk diekspor', 'error');
                return;
            }
            
            const headers = ['No', 'Tanggal', 'Waktu', 'Nama Guru', 'Kelas', 'Mata Pelajaran', 'Materi', 'Lokasi GPS', 'Status'];
            const data = teacherAttendanceData.map(record => [
                record.tanggal,
                record.waktu,
                record.nama,
                record.kelas,
                record.mapel,
                record.materi,
                record.lokasi,
                'Hadir'
            ]);
            
            const filename = `riwayat_kehadiran_guru_kepsek_${Date.now()}.csv`;
            createAndDownloadExcel(data, headers, filename);
        }

        function printKepsekRiwayatGuru() {
            showNotification(`Print laporan ${teacherAttendanceData.length} data kehadiran guru berhasil (simulasi)`, 'success');
        }

        // Override showContent to initialize location for teacher attendance
        const originalShowContent = showContent;
        showContent = function(menuId) {
            originalShowContent(menuId);
            if (menuId === 'absensi-guru') {
                initializeTeacherAttendance();
            } else if (menuId === 'riwayat-kehadiran') {
                // Initialize teacher attendance history page
                setTimeout(() => {
                    showNotification('Menampilkan riwayat kehadiran dengan verifikasi GPS dan foto', 'info');
                }, 500);
            } else if (menuId === 'kehadiran-guru-admin') {
                // Initialize admin teacher attendance page
                setTimeout(() => {
                    showNotification('Menampilkan data kehadiran guru real-time dengan kontrol admin', 'info');
                }, 500);
            } else if (menuId === 'riwayat-guru-kepsek') {
                // Initialize principal teacher history page
                setTimeout(() => {
                    showNotification('Menampilkan riwayat kehadiran guru untuk monitoring kepala sekolah', 'info');
                }, 500);
            }
        };

        // Get location when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeSampleData();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'991256ca66760517',t:'MTc2MDg5ODU0Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
